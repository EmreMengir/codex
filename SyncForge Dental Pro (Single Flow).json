{
  "name": "SyncForge Dental Pro v2 Phase1 v3",
  "nodes": [
    {
      "parameters": {
        "multipleMethods": true,
        "path": "/whatsapp-inbound",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "af338286-1052-4003-8750-b507301b5f45",
      "name": "WA Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4384,
        848
      ],
      "webhookId": "36e09ae0-5e0e-47ba-bb34-8836ffbb6ea9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.query['hub.mode'] }}",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5fffe5a1-b50d-4141-b99d-f3edab049e19",
      "name": "IF GET Verify?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -4160,
        848
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "97402b00-d718-461c-9e38-d352ad19b941",
      "name": "Respond Challenge",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -3936,
        752
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body || {}; const msg = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0] || {}; const message_id = msg.id || ''; const from = msg.from || ''; const type = msg.type || ''; const interactive_id = msg.interactive?.list_reply?.id || msg.interactive?.button_reply?.id || ''; const text_raw = msg.text?.body || msg.interactive?.button_reply?.title || msg.interactive?.list_reply?.title || ''; const timestamp_ms = msg.timestamp ? Number(msg.timestamp) * 1000 : Date.now(); const nowISO = new Date(timestamp_ms).toISOString(); const session_id = 'whatsapp:' + from; return { json: { message_id, from, type, interactive_id, text_raw, timestamp_ms, nowISO, session_id, channel: 'whatsapp' } };"
      },
      "id": "53f4380c-edbb-4e62-9bea-5b52a6a2fce5",
      "name": "Parse WhatsApp",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3712,
        944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.message_id }}",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.text_raw === '' && $json.interactive_id === '' }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "292ad878-47b2-42ab-8c2c-8b5622b9535d",
      "name": "IF Drop?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3488,
        944
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "session_id",
              "lookupValue": "={{ $json.session_id }}"
            }
          ]
        },
        "options": {
          "returnFirstMatch": true
        }
      },
      "id": "1578a4f5-4701-4026-9abb-ba9632560480",
      "name": "Sheets Get Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3264,
        944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Parse WhatsApp').item.json;\nconst existing = $input.item.json;\n\nif (existing.last_message_id === parsed.message_id) {\n  return { json: { _stop: true } };\n}\n\nconst hasValidSession = existing.session_id \n  && existing.state \n  && existing.state.trim() !== '';\n\nconst session = hasValidSession ? existing : {\n  session_id: parsed.session_id,\n  channel: parsed.channel,\n  user_id: parsed.from,\n  state: 'NEW',\n  service_id: '',\n  doctor_id: '',\n  selected_slot_start: '',\n  selected_slot_end: '',\n  hold_event_id: '',\n  hold_expires_at: '',\n  patient_name: '',\n    tc_kimlik: '',\n    birth_year: '',\n    nvi_attempts: 0,\n    flow_type: '',\n  patient_notes: '',\n  complaint_text: '',\n  complaint_tag: '',\n  last_message_id: '',\n  updated_at: ''\n};\n\nreturn { json: { ...parsed, session } };"
      },
      "id": "0dae00e8-3b3c-4d01-884d-05aa169bbd8f",
      "name": "Upsert+Idempotency",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3040,
        944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json._stop }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "cc0fd1c3-9a78-4056-8d5d-9d7f65502123",
      "name": "IF Stop?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2816,
        944
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session_id }}",
            "last_message_id": "={{ $json.message_id }}",
            "updated_at": "={{ $json.nowISO }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "46e26881-63fb-4a80-b786-dc1a0c321ec5",
      "name": "Sheets Upsert Session Early",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2592,
        944
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1259247302,
          "mode": "list",
          "cachedResultName": "services",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=1259247302"
        },
        "options": {}
      },
      "id": "a0bd9e07-e764-4901-8536-fecde1ecdfc3",
      "name": "Sheets Read Services",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2368,
        944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 907503429,
          "mode": "list",
          "cachedResultName": "doctors",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=907503429"
        },
        "options": {}
      },
      "id": "7251f805-a882-49a1-a6c5-23aa6d6f48d3",
      "name": "Sheets Read Doctors",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2144,
        944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Parse WhatsApp').first().json;\nconst sessionData = $('Upsert+Idempotency').first().json;\n\nconst interactive_id = parsed.interactive_id || '';\nconst text_raw = parsed.text_raw || '';\n\nlet event = { kind: 'text', value: '' };\n\nif (interactive_id.startsWith('svc|')) {\n  event.kind = 'svc';\n  event.value = interactive_id.substring(4);\n} else if (interactive_id.startsWith('doc|')) {\n  event.kind = 'doc';\n  event.value = interactive_id.substring(4);\n} else if (interactive_id.startsWith('slot|')) {\n  event.kind = 'slot';\n  event.value = interactive_id;\n} else if (interactive_id.startsWith('day|')) {\n  event.kind = 'day';\n  event.value = interactive_id.substring(4);\n} else if (interactive_id === 'btn_confirm') {\n  event.kind = 'confirm';\n  event.value = 'confirm';\n} else if (interactive_id === 'btn_change') {\n  event.kind = 'change';\n  event.value = 'change';\n} else if (interactive_id === 'btn_cancel') {\n  event.kind = 'cancel';\n  event.value = 'cancel';\n} else if (interactive_id === 'btn_book') {\n  event.kind = 'book';\n  event.value = 'book';\n} else {\n  event.kind = 'text';\n  event.value = text_raw.trim();\n}\n\nconst output = {\n  message_id: parsed.message_id,\n  from: parsed.from,\n  type: parsed.type,\n  interactive_id: parsed.interactive_id || '',\n  text_raw: parsed.text_raw || '',\n  timestamp_ms: parsed.timestamp_ms,\n  nowISO: parsed.nowISO,\n  session_id: sessionData.session_id,\n  channel: sessionData.channel,\n  session: sessionData.session,\n  event: event\n};\n\nreturn [{ json: output }];"
      },
      "id": "183e1cd0-b183-4fdf-869f-6f7e1a629868",
      "name": "Derive Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1920,
        944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.service_id }}",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.event.kind }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "id-3",
              "leftValue": "={{ $json.event.value.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "a72f5f55-299c-4831-824c-acdf6fbe18cf",
              "leftValue": "={{ $json.session.state }}",
              "rightValue": "COLLECTING",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "46c7b0af-b90f-47f2-aaf0-f6f5a70804bd",
      "name": "IF AI Triage?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1024,
        1424
      ]
    },
    {
      "parameters": {
        "jsCode": "// Google Sheets'ten gelen hizmetleri al\nconst services = $('Sheets Read Services').all().map(item => item.json);\n\n// AI için okunabilir bir liste oluştur\n// Örnek Çıktı: \"1 | Diş Çekimi | tags: ağrı, çekim\"\nconst services_lines = services.map(s => {\n    // service_id'yi zorla metne çevir (toString)\n    const id = s.service_id ? s.service_id.toString() : '';\n    const name = s.service_name || '';\n    const tags = s.complaint_tags || '';\n    return `${id} | ${name} | tags:${tags}`;\n}).join('\\n');\n\nreturn { json: { ...$input.item.json, services_lines } };"
      },
      "id": "1817ddb4-14d8-4fd2-8f10-10e1dd564378",
      "name": "Build Services Lines",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        1328
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an expert Dental Triage Assistant for a Turkish dental clinic. Your goal is to analyze the patient's complaint and generate a professional medical summary for the dentist.\n\nIMPORTANT CLINICAL RULE: You CANNOT diagnose or assign a specific treatment without a clinical examination. Your job is to:\n1. Understand the patient's symptoms\n2. Generate a medical summary in Turkish for the dentist\n3. Assess urgency (urgent/normal)\n4. Suggest a POSSIBLE treatment area (for informational purposes only)\n\nAVAILABLE SERVICES:\n{{ $json.services_lines }}\n\nPATIENT COMPLAINT:\n\"{{ $json.event.value }}\"\n\nROUTING RULES:\n- For ANY complaint involving pain, sensitivity, swelling, broken tooth, bleeding, or any symptom that requires clinical examination → ALWAYS use the \"Muayene\" (Examination/Consultation) service_id.\n- ONLY for cosmetic/hygiene requests that do NOT require diagnosis (e.g., \"diş temizliği\", \"beyazlatma\", \"check-up\", \"kontrol\") → You MAY use the specific service_id directly.\n- When in doubt, ALWAYS choose the Examination/Consultation service.\n\nOUTPUT FORMAT (JSON ONLY):\nReturn strictly valid JSON with no markdown blocks.\n{\n  \"intent\": \"book\",\n  \"service_id\": \"EXAMINATION_SERVICE_ID\",\n  \"suggested_treatment\": \"POSSIBLE_TREATMENT_SERVICE_ID_FOR_DOCTOR_REFERENCE\",\n  \"confidence\": 0.95,\n  \"urgency\": \"urgent/normal\",\n  \"medical_summary\": \"Hasta ... şikayeti ile başvurdu. Olası ... ön tanısı. Klinik muayene ve radyografik değerlendirme gereklidir.\"\n}\n\nRULES:\n- You MUST pick a 'service_id' exactly as it appears in the service list.\n- For pain/symptom complaints, ALWAYS pick the Examination/Consultation service_id.\n- 'suggested_treatment' is informational only - the dentist will decide after examination.\n- 'medical_summary' must be professional and in Turkish.\n- Include \"Klinik muayene gereklidir\" in the medical_summary for symptom-based complaints.",
        "batching": {}
      },
      "id": "9fd9f5e9-40b0-4b3d-8bb9-503454ef7617",
      "name": "AI Triage",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.9,
      "position": [
        -576,
        1328
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "7ac1d967-57b6-4a01-b38a-51a9620020d2",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -512,
        1552
      ],
      "credentials": {
        "openAiApi": {
          "id": "aTF6iArjfhoADgrG",
          "name": "n8n free OpenAI API credits"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Verileri Al\nconst sourceData = $items('Build Services Lines')[0].json; \nconst aiResponseText = $input.item.json.text || '{}';\n\nlet ai = {};\ntry {\n  ai = JSON.parse(aiResponseText);\n} catch(e) {\n  ai = { confidence: 0, service_id: null, medical_summary: '', suggested_treatment: '' };\n}\n\n// 2. Session Güncelle\nconst session = { ...sourceData.session };\nsession.complaint_text = sourceData.event.value;\nsession.patient_notes = ai.medical_summary || '';\n\n// 3. Hizmet Eşleştirme - confidence eşiği 0.80'e yükseltildi (Fix #7)\nif (ai.confidence >= 0.80 && ai.service_id) {\n  session.service_id = ai.service_id.toString(); \n  session.state = 'SERVICE_SELECTED';\n  // suggested_treatment bilgi amaçlı sakla\n  session.complaint_tag = ai.suggested_treatment || '';\n} else {\n  session.state = 'COLLECTING';\n}\n\nsession.updated_at = new Date().toISOString();\n\nreturn { json: { ...sourceData, session, ai } };"
      },
      "id": "0d2e41ae-3f19-4ede-aae1-e6753bbdd237",
      "name": "Merge AI->Session",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        1328
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "service_id": "={{ $json.session.service_id }}",
            "complaint_text": "={{ $json.session.complaint_text }}",
            "complaint_tag": "={{ $json.session.complaint_tag }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "1c2c6472-9d5a-42d7-b5fa-2f13897014a6",
      "name": "Sheets Update Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        0,
        1328
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind.toString() }}",
                    "rightValue": "svc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a8dca4bc-a337-48ca-928a-6840f0fcad7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Service Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session.service_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "isEmpty"
                    },
                    "id": "3557df0b-a251-4fdc-9250-f6b6c0bcbdbb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Service"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind.toString() }}",
                    "rightValue": "doc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "19a562a7-7f06-4bde-8f6a-a3f0cacf5787"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Doctor Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session.doctor_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "isEmpty"
                    },
                    "id": "0a4e9402-ca7f-42e7-a146-55d75b221254"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Doctor"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session.state.toString() }}",
                    "rightValue": "DOCTOR_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8dd5ba5d-2419-41ab-ad47-675c0fa24915"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Continue"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "0510d1b8-e6a5-4582-aefb-ab114ba6c771",
      "name": "Router A",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        224,
        1376
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "service_id": "={{ $json.event.value }}",
            "state": "SERVICE_SELECTED",
            "updated_at": "={{ $json.nowISO }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "6bdc9dcb-b236-4599-a851-e92f23fd846d",
      "name": "Sheets Update Session Service",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        448,
        464
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const services = $('Sheets Read Services').all().map(item => item.json);\nconst rows = services.map(s => ({\n  id: 'svc|' + s.service_id,\n  title: s.service_name.substring(0, 24),\n  description: (s.description || '').substring(0, 72)\n}));\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'interactive',\n  interactive: {\n    type: 'list',\n    header: {\n      type: 'text',\n      text: 'Hizmet Seçin'\n    },\n    body: {\n      text: 'Hangi işlem için randevu?'\n    },\n    action: {\n      button: 'Hizmetleri Gör',\n      sections: [{\n        title: 'Available Services',\n        rows\n      }]\n    }\n  }\n};\nreturn { json: payload };"
      },
      "id": "6a648f2c-6edf-4109-9a4b-58a6d41140c9",
      "name": "Build Services Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "3311fe45-740c-4001-8db6-7e25f5f189bc",
      "name": "WA Send Services",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        672,
        656
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "doctor_id": "={{ $json.event.value }}",
            "state": "DOCTOR_SELECTED",
            "updated_at": "={{ $json.nowISO }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "ed104c9e-520d-45c5-92d8-bea4ae86a053",
      "name": "Sheets Update Session Doctor",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        448,
        2048
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Girdi verilerini al\nconst items = $input.all();\nif (items.length === 0) return [];\n\n// 2. İlk item üzerinden seçili hizmet ID'sini al\nconst selected_service_id = items[0].json.session?.service_id || \"\";\n\n// 3. Sheets'ten okunan tüm doktorları çek\n// DİKKAT: 'Sheets Read Doctors' düğüm isminin n8n'de aynı olduğundan emin olun\nconst allDoctors = $('Sheets Read Doctors').all().map(i => i.json);\n\n// 4. Tekilleştirme ve Filtreleme\nconst uniqueDoctors = [];\nconst seenIds = new Set();\n\nallDoctors.forEach(doc => {\n  const docId = doc.doctor_id?.toString();\n  if (docId && !seenIds.has(docId)) {\n    // Doktorun verdiği hizmetleri ayır ve temizle\n    const doctorServices = (doc.service_ids || '').split(',').map(s => s.trim());\n    \n    // Eşleşme kontrolü\n    if (doctorServices.includes(selected_service_id)) {\n      uniqueDoctors.push(doc);\n      seenIds.add(docId);\n    }\n  }\n});\n\n// 5. Sonuç döndür (Eğer doktor bulunamazsa akışı durdurur, en güvenlisi budur)\nreturn uniqueDoctors.map(doc => ({\n  json: {\n    ...items[0].json,\n    doctor: doc\n  }\n}));"
      },
      "id": "0112c1d6-3061-4be1-822e-79057dd9b1ed",
      "name": "Filter Doctors",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst doctors = items.map(item => item.json.doctor);\n\n// WhatsApp limiti: Toplam satır sayısı 10'u geçemez\nconst limitedDoctors = doctors.slice(0, 10);\n\nconst rows = limitedDoctors.map(d => ({\n  id: 'doc|' + d.doctor_id,\n  title: d.doctor_name.substring(0, 24), // Karakter sınırı koruması\n  description: (d.specialization || '').substring(0, 72)\n}));\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: items[0].json.from,\n  type: 'interactive',\n  interactive: {\n    type: 'list',\n    header: { type: 'text', text: 'Doktor Seçin' },\n    body: { text: 'Şikayetinize yardımcı olabilecek doktorlarımız aşağıdadır:' },\n    action: {\n      button: 'Doktorları Gör',\n      sections: [{ title: 'Müsait Doktorlar', rows }]\n    }\n  }\n};\n\nreturn { json: payload };"
      },
      "id": "f456b2f5-05cf-4129-92d5-309fd413f116",
      "name": "Build Doctors Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        2240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "9c95357a-6547-434e-aa58-406616ea9a8b",
      "name": "WA Send Doctors",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        896,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "// Doktor + süre bilgisini çöz\n// Bu node'a 2 yoldan gelinebilir:\n// 1. Router A → nested data ($json.session.doctor_id)\n// 2. Sheets Update Session Doctor → flat data ($json.doctor_id)\n\nconst data = $input.item.json;\nconst doctor_id = data.session?.doctor_id || data.doctor_id || '';\n\n// Tüm doktorları tara\nconst doctors = $('Sheets Read Doctors').all().map(i => i.json);\nconst doctor = doctors.find(d => d.doctor_id === doctor_id);\n\nif (!doctor) {\n  return { json: { ...data, error: 'Doctor not found: ' + doctor_id } };\n}\n\n// Service bilgisini bul\nconst service_id = data.session?.service_id || data.service_id || '';\nconst services = $('Sheets Read Services').all().map(i => i.json);\nconst service = services.find(s => s.service_id === service_id);\n\nconst duration_min = service?.duration_min || 30;\nconst buffer_min = service?.buffer_min || 0;\n\nreturn { json: { \n  ...data, \n  doctor, \n  service_id,\n  slot_duration_min: duration_min, \n  buffer_min,\n  calendar_id: doctor.calendar_id\n} };"
      },
      "id": "1eff3d4b-5ef6-4626-99f7-93354d9c90ed",
      "name": "Resolve Doctor+Duration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        1504
      ]
    },
    {
      "parameters": {
        "jsCode": "const free_slots = $input.item.json.free_slots || [];\nconst prev = $('Resolve Doctor+Duration').first().json;\nconst doctor_id = prev.session?.doctor_id || prev.doctor_id || '';\nconst from = prev.from || prev.session?.user_id || $('Parse WhatsApp').first().json.from || '';\nconst event = $input.item.json.event || {};\n\nconst toDayKey = (iso) => new Date(iso).toLocaleDateString('en-CA', { timeZone: 'Europe/Istanbul' });\nconst selectedDay = event.kind === 'day' ? event.value : '';\n\nif (!selectedDay) {\n  const dayMap = new Map();\n  free_slots.forEach(slot => {\n    const dayKey = toDayKey(slot.start);\n    if (!dayMap.has(dayKey)) {\n      dayMap.set(dayKey, new Date(slot.start));\n    }\n  });\n\n  const dayRows = Array.from(dayMap.entries()).slice(0, 10).map(([dayKey, date]) => {\n    const label = date.toLocaleDateString('tr-TR', { weekday: 'long', day: '2-digit', month: 'short', timeZone: 'Europe/Istanbul' });\n    return {\n      id: 'day|' + dayKey,\n      title: label.substring(0, 24),\n      description: 'Uygun gün'\n    };\n  });\n\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'interactive',\n    interactive: {\n      type: 'list',\n      header: { type: 'text', text: 'Gün Seçin 📅' },\n      body: { text: 'Uygun bir gün seçin:' },\n      action: {\n        button: 'Günleri Gör',\n        sections: [{ title: 'Uygun Günler', rows: dayRows }]\n      }\n    }\n  };\n\n  return { json: { ...prev, free_slots, payload } };\n}\n\nconst session = { ...prev.session };\nsession.state = 'DAY_SELECTED';\nsession.updated_at = new Date().toISOString();\n\nconst maxRows = 10;\nconst filteredSlots = free_slots.filter(slot => toDayKey(slot.start) === selectedDay);\nconst limitedRows = filteredSlots.slice(0, maxRows).map(slot => {\n  const startDate = new Date(slot.start);\n  const hhmm = startDate.toTimeString().substring(0, 5);\n  const ddmmm = startDate.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', weekday: 'short' });\n  return {\n    id: 'slot|' + slot.start + '|' + doctor_id,\n    title: hhmm,\n    description: ddmmm\n  };\n});\n\nconst sections = [{ title: 'Uygun Saatler', rows: limitedRows }];\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'interactive',\n  interactive: {\n    type: 'list',\n    header: { type: 'text', text: 'Saat Seçin 🕐' },\n    body: { text: 'Seçtiğiniz gün için uygun saati seçin:' },\n    action: {\n      button: 'Saatleri Gör',\n      sections\n    }\n  }\n};\nreturn { json: { ...prev, session, free_slots, payload } };"
      },
      "id": "84fe775a-87f2-49ae-971a-5b20a582cdf3",
      "name": "Build Slots Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3136,
        1600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "d3eedaac-726e-468f-871d-3f7b5eab81e7",
      "name": "WA Send Slots",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3360,
        1600
      ]
    },
    {
      "parameters": {
        "jsCode": "const parsed = $input.item.json; const interactive_id = parsed.interactive_id || ''; if (!interactive_id.startsWith('slot|')) { return { json: $input.item.json }; } const parts = interactive_id.split('|'); const startISO = parts[1] || ''; const doctor_id = parts[2] || ''; const slot_duration_min = $input.item.json.slot_duration_min || 30; const endDate = new Date(new Date(startISO).getTime() + slot_duration_min * 60000); const session = { ...$input.item.json.session }; session.selected_slot_start = startISO; session.selected_slot_end = endDate.toISOString(); session.state = 'SLOT_SELECTED'; session.updated_at = parsed.nowISO; return { json: { ...$input.item.json, session } };"
      },
      "id": "8fd26552-63f9-4526-a927-a212ce74abb6",
      "name": "Derive Slot Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        800
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "state": "={{ $json.session.state }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "43dbf263-3dea-463d-a68c-66b49987f8ca",
      "name": "Sheets Update After Slot",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1120,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "syncforge.automation@gmail.com",
          "mode": "list",
          "cachedResultName": "syncforge.automation@gmail.com"
        },
        "start": "={{ $json.session.selected_slot_start }}",
        "end": "={{ $json.session.selected_slot_end }}",
        "additionalFields": {
          "description": "={{ 'hold|' + $json.session.session_id + '|' + $json.message_id + '|svc=' + $json.session.service_id }}",
          "showMeAs": "opaque",
          "summary": "HOLD - SyncForge Dental"
        }
      },
      "id": "aa5a90af-0607-4258-bec2-f5a903cfd08e",
      "name": "Create HOLD Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1792,
        800
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const calEvent = $input.item.json; const event_id = calEvent.id || ''; const session = { ...$('Derive Slot Event').item.json.session }; session.state = 'HELD'; session.hold_event_id = event_id; const holdExpires = new Date(Date.now() + 5 * 60000); session.hold_expires_at = holdExpires.toISOString(); session.updated_at = new Date().toISOString(); return { json: { ...$('Derive Slot Event').item.json, session } };"
      },
      "id": "adc83012-6121-4ebf-b454-b1d70bf28ad8",
      "name": "Set HELD + TTL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2016,
        800
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Set HELD + TTL').first().json.session.session_id }}",
            "state": "={{ $('Set HELD + TTL').first().json.session.state }}",
            "hold_event_id": "={{ $('Set HELD + TTL').first().json.session.hold_event_id }}",
            "hold_expires_at": "={{ $('Set HELD + TTL').first().json.session.hold_expires_at }}",
            "updated_at": "={{ $('Set HELD + TTL').first().json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "db1ae75a-937b-4ef0-880a-3d95dcb0a0db",
      "name": "Sheets Update HELD",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2240,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $('Parse WhatsApp').first().json.from,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    body: {\n      text: 'Randevunuz 5 dk rezerve edildi ⏱️\\nLütfen onaylayın:'\n    },\n    action: {\n      buttons: [\n        { type: 'reply', reply: { id: 'btn_confirm', title: '✅ Onayla' } },\n        { type: 'reply', reply: { id: 'btn_change', title: '🔄 Değiştir' } },\n        { type: 'reply', reply: { id: 'btn_cancel', title: '❌ İptal' } }\n      ]\n    }\n  }\n};\n\nreturn { json: payload };"
      },
      "id": "561d17be-ac21-4596-a9f5-6e9d815b4580",
      "name": "Build Confirm Buttons",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2464,
        800
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "a7749396-9750-4702-bf33-507d869618f0",
      "name": "WA Send Confirm",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2688,
        800
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "id-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "change",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "id-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "id-3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel"
            }
          ]
        },
        "options": {}
      },
      "id": "ed39008b-b561-4695-8d13-8863ba6b272b",
      "name": "Router Confirm/Change/Cancel",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1120,
        1600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.state }}",
              "rightValue": "HELD",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "id-3",
              "leftValue": "={{ new Date($json.session.hold_expires_at) > new Date() }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4e7534cc-d611-4b27-a688-8050932712af",
      "name": "IF Confirm Guard",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1344,
        1456
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "value": "syncforge.automation@gmail.com",
          "mode": "list",
          "cachedResultName": "syncforge.automation@gmail.com"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "updateFields": {
          "description": "={{ 'CONFIRMED|' + $json.session.session_id + '|svc=' + $json.session.service_id + '|complaint=' + $json.session.complaint_text }}",
          "summary": "={{ 'Appointment - ' + ($json.session.patient_name || $json.from) }}"
        }
      },
      "id": "0cdf5a65-30c5-4dd1-9add-2d2c4f2ea9c5",
      "name": "Confirm Event Update",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -800,
        800
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1645363573,
          "mode": "list",
          "cachedResultName": "appointments",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=1645363573"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "booking_id": "={{ $now.toISO() + '-' + Math.random().toString(36).substring(7) }}",
            "created_at": "={{ $now.toISO() }}",
            "channel": "whatsapp",
            "patient_name": "={{ $('Resolve Doctor For Confirm').first().json.session.patient_name || $('Resolve Doctor For Confirm').first().json.from }}",
            "phone": "={{ $('Resolve Doctor For Confirm').first().json.from }}",
            "complaint_text": "={{ $('Resolve Doctor For Confirm').first().json.session.complaint_text }}",
            "complaint_tag": "={{ $('Resolve Doctor For Confirm').first().json.session.complaint_tag }}",
            "service_id": "={{ $('Resolve Doctor For Confirm').first().json.session.service_id }}",
            "doctor_id": "={{ $('Resolve Doctor For Confirm').first().json.session.doctor_id }}",
            "start": "={{ $('Resolve Doctor For Confirm').first().json.session.selected_slot_start }}",
            "end": "={{ $('Resolve Doctor For Confirm').first().json.session.selected_slot_end }}",
            "status": "CONFIRMED",
            "hold_event_id": "={{ $('Resolve Doctor For Confirm').first().json.session.hold_event_id }}",
            "message_id": "={{ $('Parse WhatsApp').first().json.message_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "booking_id",
              "displayName": "booking_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "start",
              "displayName": "start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "end",
              "displayName": "end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cancelled_at",
              "displayName": "cancelled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "c1598de5-e108-40f5-8190-c4902bd559f2",
      "name": "Append Appointment Ledger",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -512,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rd = $('Resolve Doctor For Confirm').first().json;\nconst session = rd.session;\nconst from = rd.from || $('Parse WhatsApp').first().json.from;\n\nconst startDate = new Date(session.selected_slot_start);\nconst dateStr = startDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });\nconst timeStr = startDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });\nconst doctorName = rd.doctor?.doctor_name || '';\n\nconst text = '\\u2705 Randevunuz onaylandi!\\n\\n'\n  + '\\ud83d\\udcc5 ' + dateStr + '\\n'\n  + '\\ud83d\\udd50 ' + timeStr + '\\n'\n  + '\\ud83d\\udc68\\u200d\\u2695\\ufe0f ' + doctorName + '\\n'\n  + '\\ud83d\\udc64 ' + (session.patient_name || '') + '\\n\\n'\n  + 'Gorusmek uzere! \\ud83e\\uddb7';\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: text }\n};\nreturn { json: payload };"
      },
      "id": "5fc9f0f0-7abc-4f44-9118-31dc126c653a",
      "name": "Build Final Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        1088
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "b574341d-958d-4503-81d5-b604aa40a32a",
      "name": "WA Send Final",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        1088
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.interactive_id && $json.interactive_id.startsWith('slot|') }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "id-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Slot Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session && $json.session.state === 'DOCTOR_SELECTED' && (!$json.interactive_id || !$json.interactive_id.startsWith('slot|')) }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "id-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Show Slots"
            }
          ]
        },
        "options": {}
      },
      "id": "ff2ebabf-ce89-4147-926f-36ca7d8c889e",
      "name": "Router B1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        448,
        1600
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $('Sheets Read Doctors').all().map(i=>i.json); const sid = $json.session?.doctor_id || $json.event?.doctor_id || ''; const doc = doctors.find(d => d.doctor_id === sid); if(!doc) return [{json:{...$json,_stop:true,reason:'doctor_not_found_for_hold'}}]; return [{json:{...$json, doctor:doc}}];"
      },
      "id": "2dbc4e5a-0277-4093-891a-dbca68e1f59d",
      "name": "Resolve Doctor For Hold",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        736
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $('Sheets Read Doctors').all().map(i => i.json);\nconst session = $('Store Patient Notes').first().json.session;\n\nif (!session || !session.doctor_id) {\n  return [{ json: { _stop: true, reason: 'Session verisi bulunamadi' } }];\n}\n\nconst doc = doctors.find(d => d.doctor_id === session.doctor_id);\nif (!doc) {\n  return [{ json: { _stop: true, reason: 'Doktor bulunamadi: ' + session.doctor_id } }];\n}\n\nconst from = $('Parse WhatsApp').first().json.from;\nreturn [{ json: { session, doctor: doc, from } }];"
      },
      "id": "1126351e-3ced-42fd-a307-35860483a788",
      "name": "Resolve Doctor For Confirm",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        800
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json._stop }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9a5829de-3d38-401b-b0ac-ceb7efa25b9e",
      "name": "IF Stop Hold",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1568,
        736
      ]
    },
    {
      "parameters": {
        "resource": "calendar",
        "calendar": {
          "__rl": true,
          "value": "syncforge.automation@gmail.com",
          "mode": "list",
          "cachedResultName": "syncforge.automation@gmail.com"
        },
        "timeMin": "={{ $now.toISO() }}",
        "timeMax": "={{ $now.plus({days: 14}).toISO() }}",
        "options": {}
      },
      "id": "1d458210-51b7-482d-8038-519b6efd5441",
      "name": "Fetch Calendar Freebusy",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        2464,
        1504
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const slot_duration_min = $input.item.json.slot_duration_min || 30;\nconst buffer_min = $input.item.json.buffer_min || 0;\nconst total_slot_min = slot_duration_min + buffer_min;\n\n// Get busy intervals from calendar freebusy response\nconst freebusyData = $input.item.json;\nlet busyIntervals = [];\nif (freebusyData.busy) {\n  busyIntervals = freebusyData.busy;\n} else if (freebusyData.calendars) {\n  const calId = Object.keys(freebusyData.calendars)[0];\n  if (calId) busyIntervals = freebusyData.calendars[calId].busy || [];\n}\n\nconst busyTimes = busyIntervals.map(interval => ({\n  start: new Date(interval.start),\n  end: new Date(interval.end)\n}));\n\nfunction isSlotBusy(slotStart, slotEnd) {\n  return busyTimes.some(busy => (slotStart < busy.end && slotEnd > busy.start));\n}\n\n// FIX #8: Türkiye timezone'u kullan\nfunction getTurkeyDate(baseDate) {\n  const turkeyStr = baseDate.toLocaleString('en-US', { timeZone: 'Europe/Istanbul' });\n  return new Date(turkeyStr);\n}\n\nconst free_slots = [];\nconst nowUTC = new Date();\nconst nowTurkey = getTurkeyDate(nowUTC);\n\nlet businessDays = 0;\nlet dayOffset = 0;\nconst maxSlots = 50;\n\nwhile (businessDays < 10 && free_slots.length < maxSlots) {\n  const dayStart = new Date(nowTurkey);\n  dayStart.setDate(dayStart.getDate() + dayOffset);\n  const weekday = dayStart.getDay();\n  dayOffset += 1;\n\n  if (weekday === 0 || weekday === 6) {\n    continue;\n  }\n\n  dayStart.setHours(10, 0, 0, 0);\n  const dayEnd = new Date(dayStart);\n  dayEnd.setHours(18, 0, 0, 0);\n\n  const offsetMs = nowTurkey.getTime() - nowUTC.getTime();\n  let cursor = new Date(dayStart.getTime() - offsetMs);\n  const endUTC = new Date(dayEnd.getTime() - offsetMs);\n\n  if (cursor < nowUTC) {\n    const msSinceDayStart = nowUTC.getTime() - cursor.getTime();\n    const slotsToSkip = Math.ceil(msSinceDayStart / (total_slot_min * 60000));\n    cursor = new Date(cursor.getTime() + slotsToSkip * total_slot_min * 60000);\n  }\n\n  while (cursor < endUTC && free_slots.length < maxSlots) {\n    const slotStart = new Date(cursor);\n    const slotEnd = new Date(cursor.getTime() + total_slot_min * 60000);\n\n    if (slotEnd <= endUTC && !isSlotBusy(slotStart, slotEnd)) {\n      free_slots.push({\n        start: slotStart.toISOString(),\n        end: new Date(slotStart.getTime() + slot_duration_min * 60000).toISOString()\n      });\n    }\n\n    cursor.setTime(cursor.getTime() + total_slot_min * 60000);\n  }\n\n  businessDays += 1;\n}\n\nreturn { json: { ...$input.item.json, free_slots } };"
      },
      "id": "090c5a48-2753-402c-98a7-afb3ddb17213",
      "name": "Generate Real Slots from Freebusy",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2688,
        1504
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "options": {}
      },
      "id": "7591bfc3-b45b-42ad-915f-c7dd7390f181",
      "name": "Delete Hold Event (Change)",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1568,
        1136
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$('Router Confirm/Change/Cancel').item.json.session };\nsession.state = 'DOCTOR_SELECTED';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$('Router Confirm/Change/Cancel').item.json, session } };"
      },
      "id": "8be46cf6-b48d-4ede-a36e-12c666c2f1c2",
      "name": "Reset Session for Change",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1216
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "hold_expires_at": "={{ $json.session.hold_expires_at }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "04661129-f25e-437a-88ee-8cf892973661",
      "name": "Update Session After Change",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2016,
        1216
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "1d514d9e-41c4-4975-bf1b-bd99e4ede47a",
      "name": "IF Hold Exists (Change)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1344,
        1216
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "options": {}
      },
      "id": "f1aa4be9-36ad-401a-ae1d-221cab6f1683",
      "name": "Delete Hold Event (Cancel)",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1568,
        1648
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$('Router Confirm/Change/Cancel').item.json.session };\nconst hold_event_id_backup = session.hold_event_id || '';\nsession.state = 'NEW';\nsession.service_id = '';\nsession.doctor_id = '';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.patient_name = '';\nsession.complaint_text = '';\nsession.complaint_tag = '';\nsession.last_message_id = '';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$('Router Confirm/Change/Cancel').item.json, session, hold_event_id_backup } };"
      },
      "id": "5d1004bc-be9e-4bff-a6f1-71f4c684266b",
      "name": "Reset Session for Cancel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1712
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "service_id": "={{ $json.session.service_id }}",
            "doctor_id": "={{ $json.session.doctor_id }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "hold_expires_at": "={{ $json.session.hold_expires_at }}",
            "complaint_text": "={{ $json.session.complaint_text }}",
            "complaint_tag": "={{ $json.session.complaint_tag }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f1d1b37f-e2a4-46b2-b4a8-d1bac9641b9b",
      "name": "Update Session After Cancel",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2016,
        1712
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "e58f98a9-2218-470a-97b1-1b636bda881e",
      "name": "WA Send Cancel Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2688,
        2000
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $('Parse WhatsApp').first().json.from,\n  type: 'text',\n  text: {\n    body: 'Randevunuz iptal edildi. ❌\\nYeni randevu için yazabilirsiniz.'\n  }\n};\nreturn { json: payload };"
      },
      "id": "1c32c5c3-9f8b-4ff8-a372-f54bfc547773",
      "name": "Build Cancel Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2464,
        2000
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f2ae4085-cbe5-49f1-a6a0-8afc500c7259",
      "name": "IF Hold Exists (Cancel)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1344,
        1712
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.state }}",
              "rightValue": "HELD",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "id-3",
              "leftValue": "={{ new Date($json.session.hold_expires_at) < new Date() }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6502a572-eb63-480d-b9d5-7698764e0910",
      "name": "IF Hold Expired",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        672,
        1904
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "options": {}
      },
      "id": "f98ca3c0-1293-4673-82c5-1484efeeb00c",
      "name": "Delete Expired Hold",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1120,
        1952
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nsession.state = 'DOCTOR_SELECTED';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$input.item.json, session } };"
      },
      "id": "fbdaf34f-6ca4-4c38-b1b0-d32ce3287823",
      "name": "Reset Session After Expiry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        1952
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "hold_expires_at": "={{ $json.session.hold_expires_at }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "e90893da-ba64-4fb5-ae1c-49f33f580801",
      "name": "Update Session After Expiry",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1568,
        1952
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "8bbae6c6-c607-4453-b44e-573c3eaece83",
      "name": "WA Send Expiry Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2016,
        1952
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $('Parse WhatsApp').first().json.from,\n  type: 'text',\n  text: {\n    body: 'Rezervasyon süresi doldu ⏰\\nYeni saat seçin:'\n  }\n};\nreturn { json: payload };"
      },
      "id": "242b1a42-9d08-4823-8c74-47427584fd64",
      "name": "Build Expiry Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1952
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $('Sheets Read Doctors').all().map(item => item.json);\nconst session = $input.item.json.session || {};\nconst doctor_id = session.doctor_id || '';\nconst doctor = doctors.find(d => d.doctor_id === doctor_id);\n\nif (!doctor) {\n  return [{ json: { ...$input.item.json, _stop: true, reason: 'doctor_not_found_for_expiry' } }];\n}\n\nreturn [{ json: { ...$input.item.json, doctor } }];"
      },
      "id": "beeed6a2-1ecb-4180-8012-11a2bf31ca40",
      "name": "Resolve Doctor For Expiry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        1952
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "rnc-0a",
                    "leftValue": "={{ $json.session.patient_name }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Name Provided"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "rnc-1a",
                    "leftValue": "={{ $json.session.patient_name }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Name"
            }
          ]
        },
        "options": {}
      },
      "id": "eb5b6825-9c5d-4640-99c9-f30743f7befc",
      "name": "Router Name Collection",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1568,
        1456
      ]
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session }; session.state = 'AWAITING_NAME'; session.updated_at = new Date().toISOString(); const payload = { messaging_product: 'whatsapp', to: $input.item.json.from, type: 'text', text: { body: 'Harika! Randevu için ad soyadınızı yazar mısınız?' } }; return { json: { ...$input.item.json, session, payload } };"
      },
      "id": "dd6de864-1836-4bb8-9192-faf21f411b4b",
      "name": "Build Name Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1456
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Build Name Request').first().json.payload) }}",
        "options": {}
      },
      "id": "5cc657aa-9410-416f-8ca3-fd35b91703df",
      "name": "WA Send Name Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2240,
        1808
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "state": "={{ $json.session.state }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "798ff594-5ec9-4b01-8b88-29c597b89365",
      "name": "Update Session With Name",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1280,
        608
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "AWAITING_NAME",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "72ba1696-28e6-4402-ac1d-192119ab8d32",
      "name": "Sheets Update AWAITING_NAME",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2016,
        1456
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.free_slots.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "00985952-23ad-4c42-8f07-c89ef2fd1871",
      "name": "IF No Slots?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2912,
        1504
      ]
    },
    {
      "parameters": {
        "jsCode": "return { json: { messaging_product: 'whatsapp', to: $('Parse WhatsApp').first().json.from, type: 'text', text: { body: 'Maalesef 7 gün içinde müsait randevu yok 😔\\nBizi arayın veya başka doktor seçin.' } } };"
      },
      "id": "a3836f9e-44a7-4516-af18-36c499cf9037",
      "name": "Build No Slots Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3136,
        1408
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "b68bb3ef-a4fe-4973-b164-c2531bb55507",
      "name": "WA Send No Slots",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3360,
        1408
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "6d9cf374",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "b06c0c06",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "book",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Book"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "1531ca7b",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "8703a654",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "change",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "45765fc1",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "972cc0ab",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Cancel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "b730ba7d",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "d8f70465",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "0e2db773",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_TC",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "4e593379",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TC Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d488549a",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "TC_VERIFIED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "9d6f8c2a",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Fullname Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "9f6f22e2",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_BIRTH_YEAR",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "f670e166",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Birth Year Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "98c23746",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_NAME",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "051b0116",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Name Response"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "12f61f81",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_NOTES",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "00261919",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Notes Response"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "293bf016",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "NEW",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "611328ad",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Welcome New"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "49014eae",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "HELD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "6bd284b5",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELD Confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "51f38a78",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "HELD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "522ed4c5",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "change",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELD Change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "df9f97db",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "HELD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "14c60041",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELD Cancel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "7dad0179",
                    "leftValue": "={{ ['DOCTOR_SELECTED', 'DAY_SELECTED'].includes($json.session.state) }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    }
                  },
                  {
                    "id": "373ba0cc",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "slot",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Slot Selection"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "c5b98624",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "DOCTOR_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "9d05aed8",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Doctor Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "0429595e",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "COLLECTING",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Collecting"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "dddeb887",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "SERVICE_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "aef1e6bc",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "doc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Doctor From Service"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "528b991d",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "SERVICE_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Service Ask Doctor"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "68ada889",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "CONFIRMED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Already Confirmed"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "305b1542",
                    "leftValue": "={{ true }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Default Fallback"
            }
          ]
        },
        "options": {}
      },
      "id": "5a9aff0e-d8b5-479b-b46c-0dc313946cf3",
      "name": "Router State Handler Updated",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -1696,
        912
      ]
    },
    {
      "parameters": {
        "jsCode": "const from = $input.item.json.from || $('Parse WhatsApp').first().json.from;\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    header: { type: 'text', text: '🦷 SyncForge Dental' },\n    body: { text: 'Hoş geldiniz! Size nasıl yardımcı olabilirim?' },\n    action: {\n      buttons: [\n        { type: 'reply', reply: { id: 'btn_book', title: '📅 Randevu Al' } },\n        { type: 'reply', reply: { id: 'btn_change', title: '🔄 Değiştir' } },\n        { type: 'reply', reply: { id: 'btn_cancel', title: '❌ İptal' } }\n      ]\n    }\n  }\n};\nreturn { json: { ...$input.item.json, payload } };"
      },
      "id": "6dc9b29d-f3c8-4d57-82d1-9800c01b66c3",
      "name": "Build Welcome",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        1360
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "e05f7741-95dd-4f85-9a5c-40397a776211",
      "name": "WA Send Welcome",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1248,
        1360
      ]
    },
    {
      "parameters": {
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst session = { ...$input.item.json.session };\nsession.state = 'AWAITING_NOTES';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: {\n    body: 'Teşekkürler! 📝\\nDoktora iletmek istediğiniz not var mı?\\n(Yazın veya \"geç\" yazarak devam edin)'\n  }\n};\n\nreturn { json: { ...$input.item.json, session, payload } };"
      },
      "id": "bdf0b855-1ccd-4188-a936-54c4fc48690b",
      "name": "Build Notes Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        608
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "6ab915a4-9977-430e-b9c4-cc3738a8d9b2",
      "name": "WA Send Notes Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nconst rawNotes = ($input.item.json.text_raw || '').trim();\n\nif (rawNotes.toLowerCase() === 'geç' || rawNotes.toLowerCase() === 'yok' || rawNotes === '-') {\n  session.patient_notes = session.patient_notes || 'Hasta ek not belirtmedi.';\n} else {\n  const existingNotes = session.patient_notes || '';\n  session.patient_notes = existingNotes ? existingNotes + '\\nHasta notu: ' + rawNotes : rawNotes;\n}\n\nsession.state = 'CONFIRMED';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$input.item.json, session } };"
      },
      "id": "10772bc3-e973-48ea-95a5-bc290ab252e5",
      "name": "Store Patient Notes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        800
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "patient_notes": "={{ $json.session.patient_notes }}",
            "state": "={{ $json.session.state }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "211474c6-4462-4524-bdc8-37477e5d927e",
      "name": "Sheets Update Notes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1248,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nconst rawName = ($input.item.json.text_raw || '').trim();\n\nconst cleanName = rawName.replace(/[^a-zA-ZçÇğĞıİöÖşŞüÜ\\s]/g, '').trim();\n\nif (cleanName.length < 2) {\n  session.state = 'AWAITING_NAME';\n  session.updated_at = new Date().toISOString();\n  return { json: { ...$input.item.json, session, _invalid_name: true } };\n}\n\nsession.patient_name = cleanName;\nsession.state = 'AWAITING_NOTES';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$input.item.json, session } };"
      },
      "id": "d6c89b43-bdd0-4760-bb9e-df11e7038acc",
      "name": "Store Patient Name Updated",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const rd = $('Resolve Doctor For Confirm').first().json;\nconst s = rd.session;\nconst d = rd.doctor;\n\nif (!d || !d.phone) return [];\n\nconst txt = '\\ud83d\\udccb Yeni Randevu!\\n\\n'\n  + '\\ud83d\\udc64 Hasta: ' + (s.patient_name || 'Belirtilmedi') + '\\n'\n  + '\\ud83d\\udcde Telefon: ' + (rd.from || '') + '\\n'\n  + '\\ud83d\\udcc5 Tarih: ' + new Date(s.selected_slot_start).toLocaleDateString('tr-TR') + '\\n'\n  + '\\ud83d\\udd50 Saat: ' + new Date(s.selected_slot_start).toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'}) + '\\n'\n  + '\\ud83d\\udcac Sikayet: ' + (s.complaint_text || '-') + '\\n'\n  + '\\ud83d\\udcdd Not: ' + (s.patient_notes || '-');\n\nreturn { json: { messaging_product: 'whatsapp', to: d.phone, type: 'text', text: { body: txt } } };"
      },
      "id": "4bb53bf8-79a3-4acc-b0da-6eb09c8fc534",
      "name": "Build Doctor WA Notify",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        704
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "c93cc52c-1c68-49c3-8a3b-5ed4518c5afb",
      "name": "WA Send Doctor Notify",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        704
      ]
    },
    {
      "parameters": {
        "jsCode": "const rd = $('Resolve Doctor For Confirm').first().json;\nconst s = rd.session;\nconst d = rd.doctor;\nif (!d.phone) return [];\nreturn { json: { phone: d.phone, message: 'Yeni Randevu: ' + s.patient_name + ' - ' + s.selected_slot_start } };"
      },
      "id": "315c2a51-747f-4035-bcbf-dd814c57cc9d",
      "name": "Build Doctor SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        896
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.netgsm.com.tr/sms/send/get",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "usercode",
              "value": "<__PLACEHOLDER_VALUE__USERCODE__>"
            },
            {
              "name": "password",
              "value": "<__PLACEHOLDER_VALUE__PASSWORD__>"
            },
            {
              "name": "gsmno",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.message }}"
            }
          ]
        },
        "options": {}
      },
      "id": "224bad6e-8c85-4cb0-ad42-b1fb9ab80303",
      "name": "Send SMS Netgsm",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        896
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1645363573,
          "mode": "list",
          "cachedResultName": "appointments",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=1645363573"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "status": "CANCELLED",
            "cancelled_at": "={{ $now.toISO() }}",
            "row_number": 0
          },
          "matchingColumns": [
            "hold_event_id"
          ],
          "schema": [
            {
              "id": "booking_id",
              "displayName": "booking_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "start",
              "displayName": "start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "end",
              "displayName": "end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cancelled_at",
              "displayName": "cancelled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "edab7890-cbdd-44db-a9bb-43e1589c221f",
      "name": "Update Appointment Cancelled",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2240,
        2000
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "emremengir@gmail.com",
        "subject": "=Yeni Randevu Onaylandı - {{ $('Resolve Doctor For Confirm').item.json.session.patient_name || 'Hasta' }}",
        "emailType": "text",
        "message": "=Sayın Doktor,\n\nYeni bir randevu oluşturuldu:\n--------------------------------\n👤 Hasta: {{ $('Resolve Doctor For Confirm').item.json.session.patient_name }}\n📞 Telefon: {{ $('Resolve Doctor For Confirm').item.json.from }}\n📝 Şikayet: {{ $('Resolve Doctor For Confirm').item.json.session.complaint_text }}\n📅 Tarih/Saat: {{ $('Resolve Doctor For Confirm').item.json.session.selected_slot_start }}\n--------------------------------\n\nLütfen takviminizi kontrol ediniz.",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        -304,
        800
      ],
      "id": "985e5f92-e68f-448d-be32-ba3a8ab7bb3c",
      "name": "Send a message",
      "webhookId": "7366e9a0-3f64-4768-bf93-f1f4950a6c46",
      "credentials": {
        "gmailOAuth2": {
          "id": "cW17YBtpA6glF504",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "gid=0",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Build Welcome').first().json.session.session_id }}",
            "state": "INIT",
            "updated_at": "={{ $now.toISO() }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        3648,
        1264
      ],
      "id": "dfd99204-5946-4410-bee8-648bf8b71d94",
      "name": "Update State After Welcome",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nconst holdEventId = session.hold_event_id || '';\n\n// Session'ı DOCTOR_SELECTED'a geri al\nsession.state = 'DOCTOR_SELECTED';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'text',\n  text: {\n    body: '⏰ Rezervasyon süreniz dolmuş.\\nEndişelenmeyin, yeni saatler yükleniyor...'\n  }\n};\n\nreturn { json: { ...$input.item.json, session, payload, expired_hold_event_id: holdEventId } };"
      },
      "id": "1f61a333-4fa7-4569-8fc8-c066b8e98eb1",
      "name": "Handle Expired On Confirm",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        1664
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQjKcQuYRMRVNIqImyW6ip8wJkbIySS1vp6Hu5ro9X5Tbfqjd4FGAAn70mFBw1bvUZCHpCP5BWEhZCFcJNqvg9PBZB22xYYGneGA0PrnKPRxJWPmz1p4cwOlIdSEFkAMVR5AqGi98uNpDMxwTMIkcMmN2pGoaubM2Szj08yRRUPscUxoyGardRHy9X6iZBQPdOZCEUTlE7Dj2VEGOvTa1DLqPKmZBeuQ0V3oIjfeDFoj9yTG4YdGfmdRKXUOXQZBEEYOX8AcOlHx"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "790ffd58-916c-4b04-b63f-2e0d93143b2d",
      "name": "WA Send Expired Confirm Msg",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1936,
        1664
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "selected_slot_start": "",
            "selected_slot_end": "",
            "hold_event_id": "",
            "hold_expires_at": "",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "b56fa396-6953-4bb1-9108-f675e6fadc98",
      "name": "Sheets Update Expired Confirm",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2240,
        1664
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.expired_hold_event_id }}",
        "options": {}
      },
      "id": "a392e0d5-1b38-44f6-b818-075281d3d429",
      "name": "Delete Expired Hold On Confirm",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1936,
        1856
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Resolve Doctor For Confirm').first().json.session.session_id }}",
            "state": "CONFIRMED",
            "updated_at": "={{ $now.toISO() }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "09158b97-ef53-471f-bd07-76dc8204398b",
      "name": "Sheets Set CONFIRMED",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -208,
        960
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "fix5-1",
              "leftValue": "={{ $json.session.hold_event_id_backup || '' }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "218b2af7-9f1c-45ce-9032-60280e2dc632",
      "name": "IF Ledger Entry Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1984,
        2000
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "fix10-1",
              "leftValue": "={{ $json._invalid_name }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "68691906-6daf-4970-b502-bdaef83ab165",
      "name": "IF Invalid Name",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1168,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'text',\n  text: { body: 'Lütfen geçerli bir ad soyad giriniz. 🙏\\nÖrnek: Ahmet Yılmaz' }\n};\nreturn { json: payload };"
      },
      "id": "a7184ba0-00a9-4430-ae20-2453e6cafdb7",
      "name": "Build Retry Name Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        512
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "424ea6c1-a9ba-449f-83c4-4903e3ded2b0",
      "name": "WA Send Retry Name",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'text',\n  text: {\n    body: '✅ Zaten onaylanmış bir randevunuz var!\\n\\nRandevunuzu değiştirmek veya iptal etmek için kliniği arayabilirsiniz.\\n📞 İletişim için: (klinik telefonu)'\n  }\n};\nreturn { json: payload };"
      },
      "id": "73e74b85-f9e6-4ca2-aea4-709fc5515932",
      "name": "Build Already Confirmed Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        1712
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "e3c5f3d5-c0e4-47af-8376-c8f501eb0223",
      "name": "WA Send Already Confirmed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -992,
        1712
      ]
    },
    {
      "parameters": {
        "jsCode": "const original = $('Merge AI->Session').first().json;\nreturn { json: original };"
      },
      "id": "243cdd61-1b92-453e-a8ba-567194a4bb2c",
      "name": "Restore Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        1328
      ]
    },
    {
      "parameters": {
        "jsCode": "const original = $('Build Welcome').first().json;\nconst session = { ...original.session };\nsession.state = 'INIT'; // <-- değişiklik burada\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...original, session } };\n"
      },
      "id": "0b9f3859-1262-4e51-9e10-c2aeff40a5c8",
      "name": "Restore Welcome Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        1264
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst session = { ...$input.item.json.session };\n\n// Yeni randevu — tüm eski verileri sıfırla\nsession.state = 'AWAITING_TC';\nsession.flow_type = 'book';\nsession.nvi_attempts = 0;\nsession.tc_kimlik = '';\nsession.patient_name = '';\nsession.birth_year = '';\nsession.service_id = '';\nsession.doctor_id = '';\nsession.complaint_text = '';\nsession.complaint_tag = '';\nsession.patient_notes = '';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '🆔 Lütfen TC Kimlik numaranızı girin (11 hane):' }\n};\n\nreturn { json: { ...$input.item.json, session, payload } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        720
      ],
      "id": "23e9fb04-80a8-4386-aaa2-01c62b181edd",
      "name": "Handle Book Button"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "flow_type": "={{ $json.session.flow_type }}",
            "nvi_attempts": "0",
            "tc_kimlik": "",
            "patient_name": "",
            "birth_year": "",
            "service_id": "",
            "doctor_id": "",
            "complaint_text": "",
            "complaint_tag": "",
            "patient_notes": "",
            "selected_slot_start": "",
            "selected_slot_end": "",
            "hold_event_id": "",
            "hold_expires_at": "",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1200,
        720
      ],
      "id": "dd28fc83-7a71-414e-a09e-e2ea6d8fc167",
      "name": "Sheets Update AWAITING_TC",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Handle Book Button').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        720
      ],
      "id": "ba0686df-d5bf-4891-93d6-ec63367e2018",
      "name": "WA Send TC Request"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst tc = ($input.item.json.text_raw || '').trim();\nconst session = { ...$input.item.json.session };\n\n// TC Kimlik algoritma doğrulaması\nfunction validateTC(tc) {\n  if (!/^\\d{11}$/.test(tc)) return false;\n  if (tc[0] === '0') return false;\n  const d = tc.split('').map(Number);\n  const odd = d[0] + d[2] + d[4] + d[6] + d[8];\n  const even = d[1] + d[3] + d[5] + d[7];\n  if ((odd * 7 - even) % 10 !== d[9]) return false;\n  if (d.slice(0, 10).reduce((a, b) => a + b, 0) % 10 !== d[10]) return false;\n  return true;\n}\n\nconst isValid = validateTC(tc);\n\nif (isValid) {\n  session.tc_kimlik = tc;\n  session.state = 'TC_VERIFIED';\n  session.updated_at = new Date().toISOString();\n  \n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '✅ TC doğrulandı.\\nLütfen adınızı ve soyadınızı girin:' }\n  };\n  return { json: { ...$input.item.json, session, payload, tc_valid: true } };\n} else {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '❌ Geçersiz TC Kimlik numarası.\\nLütfen 11 haneli TC numaranızı tekrar girin:' }\n  };\n  return { json: { ...$input.item.json, session, payload, tc_valid: false } };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        528
      ],
      "id": "f52929ef-36a7-4073-aae5-02c5df6df693",
      "name": "Process TC Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "tc1",
              "leftValue": "={{ $json.tc_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1200,
        528
      ],
      "id": "49183934-2282-444c-86c7-89e5fad98f54",
      "name": "IF TC Valid?"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "tc_kimlik": "={{ $json.session.tc_kimlik }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -960,
        464
      ],
      "id": "9318a5db-d664-4190-9dab-0d232d2c3c94",
      "name": "Sheets Update AWAITING_FULLNAME",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process TC Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        464
      ],
      "id": "2de0ea92-0f0e-4e70-a283-ac0ed00f7109",
      "name": "WA Send TC Flow"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process TC Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        592
      ],
      "id": "4d52e889-1cde-44ef-a687-475c33d11540",
      "name": "WA Send TC Error"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst fullname = ($input.item.json.text_raw || '').trim();\nconst session = { ...$input.item.json.session };\n\nif (fullname.length < 3 || !fullname.includes(' ')) {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '❌ Lütfen adınızı ve soyadınızı boşlukla ayırarak girin:\\nÖrnek: Emre Mengir' }\n  };\n  return { json: { ...$input.item.json, session, payload, name_valid: false } };\n}\n\nsession.patient_name = fullname;\nsession.state = 'AWAITING_BIRTH_YEAR';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '📅 Doğum yılınızı girin (4 hane):\\nÖrnek: 1990' }\n};\n\nreturn { json: { ...$input.item.json, session, payload, name_valid: true } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        320
      ],
      "id": "6d87bca1-1efb-40e5-a837-13e701d92b8b",
      "name": "Process Fullname Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "nm1",
              "leftValue": "={{ $json.name_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1200,
        320
      ],
      "id": "c0f756d5-4d8a-4a9b-ac3b-ba659c6da3ed",
      "name": "IF Name Valid?"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "birth_year": "="
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -944,
        272
      ],
      "id": "112f17b3-63ca-499c-88ea-4f72406f20aa",
      "name": "Sheets Update AWAITING_BIRTH_YEAR",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process Fullname Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        272
      ],
      "id": "9da5416e-f843-4c89-8ab2-7e47ee97578c",
      "name": "WA Send Name Flow"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst yearStr = ($input.item.json.text_raw || '').trim();\nconst session = { ...$input.item.json.session };\nconst year = parseInt(yearStr);\n\n// 1. Yıl Geçerlilik Kontrolü\nif (!/^\\d{4}$/.test(yearStr) || year < 1920 || year > 2010) {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '❌ Geçersiz doğum yılı.\\nLütfen 4 haneli doğum yılınızı girin (örn: 1990):' }\n  };\n  return { json: { ...$input.item.json, session, payload, year_valid: false } };\n}\n\nsession.birth_year = yearStr;\nsession.updated_at = new Date().toISOString();\n\n// 2. TÜRKÇE KARAKTER VE SMART SPLIT (Critical Fix)\nfunction toNVIUpper(text) {\n    if (!text) return \"\";\n    return text\n        .replace(/i/g, 'İ')\n        .replace(/ı/g, 'I')\n        .toUpperCase()\n        .trim();\n}\n\nconst cleanFullName = toNVIUpper(session.patient_name || '');\nconst nameParts = cleanFullName.split(/\\s+/); // Boşluklara göre böl\n\n// NVI Mantığı: Son kelime SOYAD, geri kalan her şey AD\nlet ad = \"\";\nlet soyad = \"\";\n\nif (nameParts.length > 1) {\n    soyad = nameParts.pop(); // Son elemanı çıkar ve soyad yap\n    ad = nameParts.join(\" \"); // Kalanların hepsini birleştirerek ad yap\n} else {\n    ad = nameParts[0] || \"\";\n    soyad = \"\"; // Soyad boşsa NVI büyük ihtimalle reddeder, akışta bu kontrol edilmeli\n}\n\n// 3. SOAP XML Oluşturma\nconst soapXml = `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">\n  <soap:Body>\n    <TCKimlikNoDogrula xmlns=\"http://tckimlik.nvi.gov.tr/WS\">\n      <TCKimlikNo>${session.tc_kimlik}</TCKimlikNo>\n      <Ad>${ad}</Ad>\n      <Soyad>${soyad}</Soyad>\n      <DogumYili>${session.birth_year}</DogumYili>\n    </TCKimlikNoDogrula>\n  </soap:Body>\n</soap:Envelope>`;\n\nreturn { json: { ...$input.item.json, session, soapXml, year_valid: true, from, ad, soyad } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        128
      ],
      "id": "d28b5277-97a0-4dce-b18a-4e61c1e63ffc",
      "name": "Process Birth Year Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "yr1",
              "leftValue": "={{ $json.year_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1232,
        128
      ],
      "id": "fb9d2d02-e3cc-40c2-9dfc-4d27299e6c57",
      "name": "IF Year Valid?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "=$('Process Birth Year Input').first().json.payload",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        192
      ],
      "id": "ec96de74-7b6c-4c78-ae54-6849aa9c81a8",
      "name": "WA Send Year Error"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tckimlik.nvi.gov.tr/Service/KPSPublic.asmx",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "text/xml; charset=utf-8"
            },
            {
              "name": "SOAPAction",
              "value": "\"http://tckimlik.nvi.gov.tr/WS/TCKimlikNoDogrula\""
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "text/xml; charset=utf-8",
        "body": "={{ $json.soapXml }}",
        "options": {
          "redirect": {
            "redirect": {}
          },
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        48
      ],
      "id": "6da027d9-ad7e-450e-916e-633a60fe198a",
      "name": "NVI SOAP Call"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from =\n  $json.from ||\n  $json?.session?.user_id ||\n  $('Parse WhatsApp').first().json.from; // en son fallback\n\nconst session = { ...($json.session || {}) };\n\n// NVI HTTP response text'i yakala\nconst responseText = String($json.data || $json.body || '');\n\n// 1) Önce SOAP sonucu var mı kontrol et\nconst hasSoapResult = /TCKimlikNoDogrulaResult/i.test(responseText);\n\n// 2) Servis hata sayfası / HTML geldi mi?\nconst looksLikeHtml = /<html|<div|master-body|yetkiniz yoktur|teknik bir hata/i.test(responseText);\n\nlet nvi_status = 'UNKNOWN';\nlet nvi_valid = false;\n\nif (hasSoapResult) {\n  nvi_status = 'OK';\n  nvi_valid = /<TCKimlikNoDogrulaResult>\\s*true\\s*<\\/TCKimlikNoDogrulaResult>/i.test(responseText);\n} else if (looksLikeHtml || responseText.trim() === '') {\n  nvi_status = 'SERVICE_ERROR';\n} else {\n  nvi_status = 'BAD_RESPONSE';\n}\n\nsession.updated_at = new Date().toISOString();\n\nif (nvi_status === 'OK' && nvi_valid) {\n  session.state = 'COLLECTING';\n\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: {\n      body:\n        `✅ Kimlik doğrulandı!\\nHoş geldiniz ${session.patient_name || ''}! 🦷\\n\\n` +\n        `Şimdi şikayetinizi veya hangi işlem için geldiğinizi yazın.\\n\\n` +\n        `Örnek: \"Diş ağrısı\" veya \"Diş temizliği\"`,\n    },\n  };\n\n  return { json: { ...$json, session, payload, nvi_valid: true, nvi_status } };\n}\n\n// --- SERVİS HATASI: Kullanıcıyı yanlış yönlendirme ---\nif (nvi_status !== 'OK') {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: {\n      body:\n        '⚠️ NVI kimlik doğrulama servisine şu an ulaşılamıyor.\\n' +\n        'Lütfen birkaç dakika sonra tekrar deneyin.\\n\\n' +\n        'Devam etmek isterseniz TC kimlik numaranızı tekrar yazın:',\n    },\n  };\n\n  // burada istersen state'i AWAITING_TC yap\n  session.state = 'AWAITING_TC';\n\n  return { json: { ...$json, session, payload, nvi_valid: false, nvi_status } };\n}\n\n// --- OK ama eşleşmedi ---\nsession.nvi_attempts = (parseInt(session.nvi_attempts) || 0) + 1;\n\nif (session.nvi_attempts >= 3) {\n  session.state = 'INIT';\n  session.tc_kimlik = '';\n  session.patient_name = '';\n  session.birth_year = '';\n\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: {\n      body:\n        '❌ Kimlik bilgileri 3 kez doğrulanamadı.\\n' +\n        'Lütfen kliniğimizi arayarak randevu alabilirsiniz.\\n📞 (0332) XXX XX XX',\n    },\n  };\n\n  return { json: { ...$json, session, payload, nvi_valid: false, nvi_status: 'MISMATCH' } };\n}\n\nsession.state = 'AWAITING_TC';\nsession.tc_kimlik = '';\nsession.patient_name = '';\nsession.birth_year = '';\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: {\n    body: `❌ Bilgiler eşleşmedi (Deneme ${session.nvi_attempts}/3).\\nLütfen TC Kimlik numaranızı tekrar girin:`,\n  },\n};\n\nreturn { json: { ...$json, session, payload, nvi_valid: false, nvi_status: 'MISMATCH' } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        48
      ],
      "id": "c155ab09-8995-480b-b85b-984398441126",
      "name": "Parse NVI Response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "nvi1",
              "leftValue": "={{ $json.nvi_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -336,
        48
      ],
      "id": "ee58b9f6-ee8c-4cbc-8419-31832dd9b8ea",
      "name": "IF NVI Valid?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "tc_kimlik": "={{ $json.session.tc_kimlik }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "birth_year": "={{ $json.session.birth_year || \"\" }}",
            "nvi_attempts": "={{ $json.session.nvi_attempts || 0 }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        0,
        0
      ],
      "id": "5d98c335-135e-451f-a446-c43c43c4b918",
      "name": "Sheets Update After NVI",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Parse NVI Response').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        0
      ],
      "id": "3306505f-9082-4b2e-a63c-c4e233890203",
      "name": "WA Send NVI Result"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "nvi_attempts": "={{ $json.session.nvi_attempts || 0 }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        0,
        128
      ],
      "id": "a6c4075a-1776-419d-8e95-29c72892f112",
      "name": "Sheets Update NVI Fail",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Parse NVI Response').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        128
      ],
      "id": "de1dd473-9f41-4bac-a6f1-b66e8515a617",
      "name": "WA Send NVI Error"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '🔄 Randevu değiştirme özelliği yakında aktif olacaktır.\\nLütfen kliniğimizi arayın:\\n📞 (0332) XXX XX XX' }\n};\nreturn { json: { payload } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        864
      ],
      "id": "20d3958d-f6e0-4499-a670-0954ec0e52da",
      "name": "Handle Change Button"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1200,
        864
      ],
      "id": "06f819fa-3327-4508-8715-187c38b4ce92",
      "name": "WA Send Change Placeholder"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '❌ Randevu iptal özelliği yakında aktif olacaktır.\\nLütfen kliniğimizi arayın:\\n📞 (0332) XXX XX XX' }\n};\nreturn { json: { payload } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        1008
      ],
      "id": "1f66c03d-a9d2-4c9c-be93-c2dd84c86252",
      "name": "Handle Cancel Button"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1200,
        1008
      ],
      "id": "f7a57e47-374d-4320-8a44-d4fccc524f07",
      "name": "WA Send Cancel Placeholder"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "AWAITING_NOTES",
            "updated_at": "={{ $now.toISO() }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1440,
        592
      ],
      "id": "a20ed738-5278-4f90-bef9-0cab29ce1e38",
      "name": "Sheets Update Skip To Notes",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "birth_year": "={{ $json.session.birth_year || \"\" }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1184,
        -80
      ],
      "id": "2750eaa2-7900-43f0-b607-42148e17f46d",
      "name": "Sheets Update AWAITING_BIRTH_YEAR1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQl7LCqw289j8oCrgvUcRVQdNkJltz8qZComsWuqo9tJkQTyP24DgBGLp1XbZAMFlLQH48wEW2nTObxkN5FobmN3oxCeR88cNltQVpMOoasN9UwF6DBxAXzqdVeydPRwIPpfCZCKkUeZARdJVxdiQZCfVPwjcXLaFEPYzZAkBcCxJ5nkpqmkcpplSMzXygtsEbnZBQ9VQfDLBEKBZAstReQKhCVrMzfvtTf0SXekJlaZCNvJIwRofyI86ZCImfZBkAGSlUzYY95uZBzL3"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process Fullname Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        384
      ],
      "id": "4f3b2e71-a75e-4513-a522-2498b9481120",
      "name": "WA Send Name Error"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -752,
        48
      ],
      "id": "9f79c197-de02-4ca5-aac9-5ed325e7a7e2",
      "name": "Merge"
    }
  ],
  "pinData": {},
  "connections": {
    "WA Webhook": {
      "main": [
        [],
        [
          {
            "node": "IF GET Verify?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF GET Verify?": {
      "main": [
        [
          {
            "node": "Respond Challenge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse WhatsApp": {
      "main": [
        [
          {
            "node": "IF Drop?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Drop?": {
      "main": [
        [],
        [
          {
            "node": "Sheets Get Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Get Session": {
      "main": [
        [
          {
            "node": "Upsert+Idempotency",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert+Idempotency": {
      "main": [
        [
          {
            "node": "IF Stop?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Stop?": {
      "main": [
        [],
        [
          {
            "node": "Sheets Upsert Session Early",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Upsert Session Early": {
      "main": [
        [
          {
            "node": "Sheets Read Services",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Read Services": {
      "main": [
        [
          {
            "node": "Sheets Read Doctors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Read Doctors": {
      "main": [
        [
          {
            "node": "Derive Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF AI Triage?": {
      "main": [
        [
          {
            "node": "Build Services Lines",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router A",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Services Lines": {
      "main": [
        [
          {
            "node": "AI Triage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Triage",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Triage": {
      "main": [
        [
          {
            "node": "Merge AI->Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge AI->Session": {
      "main": [
        [
          {
            "node": "Sheets Update Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router A": {
      "main": [
        [
          {
            "node": "Sheets Update Session Service",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Services Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Update Session Doctor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Filter Doctors",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router B1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Services Payload": {
      "main": [
        [
          {
            "node": "WA Send Services",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Doctors": {
      "main": [
        [
          {
            "node": "Build Doctors Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doctors Payload": {
      "main": [
        [
          {
            "node": "WA Send Doctors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor+Duration": {
      "main": [
        [
          {
            "node": "Fetch Calendar Freebusy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Slots Payload": {
      "main": [
        [
          {
            "node": "WA Send Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Derive Slot Event": {
      "main": [
        [
          {
            "node": "Sheets Update After Slot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update After Slot": {
      "main": [
        [
          {
            "node": "Create HOLD Event",
            "type": "main",
            "index": 0
          },
          {
            "node": "Resolve Doctor For Hold",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create HOLD Event": {
      "main": [
        [
          {
            "node": "Set HELD + TTL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set HELD + TTL": {
      "main": [
        [
          {
            "node": "Sheets Update HELD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update HELD": {
      "main": [
        [
          {
            "node": "Build Confirm Buttons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Confirm Buttons": {
      "main": [
        [
          {
            "node": "WA Send Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Confirm/Change/Cancel": {
      "main": [
        [
          {
            "node": "IF Confirm Guard",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Hold Exists (Change)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Hold Exists (Cancel)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Confirm Guard": {
      "main": [
        [
          {
            "node": "Router Name Collection",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Expired On Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirm Event Update": {
      "main": [
        [
          {
            "node": "Append Appointment Ledger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Appointment Ledger": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sheets Set CONFIRMED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Final Text": {
      "main": [
        [
          {
            "node": "WA Send Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router B1": {
      "main": [
        [
          {
            "node": "Derive Slot Event",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF Hold Expired",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor For Hold": {
      "main": [
        [
          {
            "node": "IF Stop Hold",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Stop Hold": {
      "main": [
        [],
        [
          {
            "node": "Create HOLD Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor For Confirm": {
      "main": [
        [
          {
            "node": "Confirm Event Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Calendar Freebusy": {
      "main": [
        [
          {
            "node": "Generate Real Slots from Freebusy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Real Slots from Freebusy": {
      "main": [
        [
          {
            "node": "IF No Slots?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Hold Exists (Change)": {
      "main": [
        [
          {
            "node": "Delete Hold Event (Change)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reset Session for Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Hold Event (Change)": {
      "main": [
        [
          {
            "node": "Reset Session for Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Session for Change": {
      "main": [
        [
          {
            "node": "Update Session After Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session After Change": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Hold Exists (Cancel)": {
      "main": [
        [
          {
            "node": "Delete Hold Event (Cancel)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reset Session for Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Hold Event (Cancel)": {
      "main": [
        [
          {
            "node": "Reset Session for Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Session for Cancel": {
      "main": [
        [
          {
            "node": "Update Session After Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session After Cancel": {
      "main": [
        [
          {
            "node": "IF Ledger Entry Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Cancel Message": {
      "main": [
        [
          {
            "node": "WA Send Cancel Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Hold Expired": {
      "main": [
        [
          {
            "node": "Resolve Doctor For Expiry",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Derive Slot Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor For Expiry": {
      "main": [
        [
          {
            "node": "Delete Expired Hold",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Expired Hold": {
      "main": [
        [
          {
            "node": "Reset Session After Expiry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Session After Expiry": {
      "main": [
        [
          {
            "node": "Update Session After Expiry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session After Expiry": {
      "main": [
        [
          {
            "node": "Build Expiry Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Expiry Message": {
      "main": [
        [
          {
            "node": "WA Send Expiry Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Send Expiry Message": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Name Collection": {
      "main": [
        [
          {
            "node": "Sheets Update Skip To Notes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Name Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Name Request": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_NAME",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session With Name": {
      "main": [
        [
          {
            "node": "Build Notes Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Derive Event": {
      "main": [
        [
          {
            "node": "Router State Handler Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_NAME": {
      "main": [
        [
          {
            "node": "WA Send Name Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF No Slots?": {
      "main": [
        [
          {
            "node": "Build No Slots Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Slots Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build No Slots Msg": {
      "main": [
        [
          {
            "node": "WA Send No Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router State Handler Updated": {
      "main": [
        [
          {
            "node": "Handle Book Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Change Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Cancel Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Welcome",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process TC Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Fullname Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Birth Year Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Store Patient Name Updated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Store Patient Notes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Welcome",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router Confirm/Change/Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router Confirm/Change/Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router Confirm/Change/Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Derive Slot Event",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF AI Triage?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Update Session Doctor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Filter Doctors",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Already Confirmed Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Welcome": {
      "main": [
        [
          {
            "node": "WA Send Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Send Welcome": {
      "main": [
        [
          {
            "node": "Update State After Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Patient Name Updated": {
      "main": [
        [
          {
            "node": "IF Invalid Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Notes Request": {
      "main": [
        [
          {
            "node": "WA Send Notes Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Patient Notes": {
      "main": [
        [
          {
            "node": "Sheets Update Notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Notes": {
      "main": [
        [
          {
            "node": "Resolve Doctor For Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doctor WA Notify": {
      "main": [
        [
          {
            "node": "WA Send Doctor Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doctor SMS": {
      "main": [
        [
          {
            "node": "Send SMS Netgsm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Appointment Cancelled": {
      "main": [
        [
          {
            "node": "Build Cancel Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a message": {
      "main": [
        [
          {
            "node": "Build Doctor WA Notify",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Doctor SMS",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Final Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Session Doctor": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Expired On Confirm": {
      "main": [
        [
          {
            "node": "WA Send Expired Confirm Msg",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sheets Update Expired Confirm",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete Expired Hold On Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Expired Confirm": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Ledger Entry Exists": {
      "main": [
        [
          {
            "node": "Update Appointment Cancelled",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Cancel Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Session": {
      "main": [
        [
          {
            "node": "Restore Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Invalid Name": {
      "main": [
        [
          {
            "node": "Build Retry Name Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Session With Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Retry Name Msg": {
      "main": [
        [
          {
            "node": "WA Send Retry Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Session Service": {
      "main": [
        [
          {
            "node": "Filter Doctors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Already Confirmed Msg": {
      "main": [
        [
          {
            "node": "WA Send Already Confirmed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Context": {
      "main": [
        [
          {
            "node": "Router A",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State After Welcome": {
      "main": [
        [
          {
            "node": "Restore Welcome Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Welcome Context": {
      "main": [
        [
          {
            "node": "IF AI Triage?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Book Button": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_TC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_TC": {
      "main": [
        [
          {
            "node": "WA Send TC Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process TC Input": {
      "main": [
        [
          {
            "node": "IF TC Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF TC Valid?": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_FULLNAME",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Send TC Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_FULLNAME": {
      "main": [
        [
          {
            "node": "WA Send TC Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Fullname Input": {
      "main": [
        [
          {
            "node": "IF Name Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Name Valid?": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_BIRTH_YEAR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Send Name Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_BIRTH_YEAR": {
      "main": [
        [
          {
            "node": "WA Send Name Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Birth Year Input": {
      "main": [
        [
          {
            "node": "IF Year Valid?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sheets Update AWAITING_BIRTH_YEAR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Year Valid?": {
      "main": [
        [
          {
            "node": "NVI SOAP Call",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Send Year Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NVI SOAP Call": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse NVI Response": {
      "main": [
        [
          {
            "node": "IF NVI Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF NVI Valid?": {
      "main": [
        [
          {
            "node": "Sheets Update After NVI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Update NVI Fail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update After NVI": {
      "main": [
        [
          {
            "node": "WA Send NVI Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update NVI Fail": {
      "main": [
        [
          {
            "node": "WA Send NVI Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Change Button": {
      "main": [
        [
          {
            "node": "WA Send Change Placeholder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Cancel Button": {
      "main": [
        [
          {
            "node": "WA Send Cancel Placeholder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Skip To Notes": {
      "main": [
        [
          {
            "node": "Build Notes Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_BIRTH_YEAR1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Parse NVI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "fb0a3bc6-b0d6-4002-b26c-fc08d83d31ad",
  "meta": {
    "instanceId": "bed97b5b7d807e8a88d9f97466b8d7787025c0cfbaaba67e1749d8eef9d2ed3a"
  },
  "id": "jad_ktIKgQM9aGK9QOV1r",
  "tags": []
}