{
  "name": "SyncForge Dental Pro v2 Phase1 v3",
  "nodes": [
    {
      "parameters": {
        "multipleMethods": true,
        "path": "/whatsapp-inbound",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "8ee6fdfc-8b96-48af-94c9-e10f8e43b179",
      "name": "WA Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4384,
        848
      ],
      "webhookId": "36e09ae0-5e0e-47ba-bb34-8836ffbb6ea9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.query['hub.mode'] }}",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d265474c-fc7d-4379-a560-9df6a9b1963e",
      "name": "IF GET Verify?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -4160,
        848
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "b3f1e452-49ce-4c54-9498-211c3d57d4df",
      "name": "Respond Challenge",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -3936,
        752
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body || {}; const msg = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0] || {}; const message_id = msg.id || ''; const from = msg.from || ''; const type = msg.type || ''; const interactive_id = msg.interactive?.list_reply?.id || msg.interactive?.button_reply?.id || ''; const text_raw = msg.text?.body || msg.interactive?.button_reply?.title || msg.interactive?.list_reply?.title || ''; const timestamp_ms = msg.timestamp ? Number(msg.timestamp) * 1000 : Date.now(); const nowISO = new Date(timestamp_ms).toISOString(); const session_id = 'whatsapp:' + from; return { json: { message_id, from, type, interactive_id, text_raw, timestamp_ms, nowISO, session_id, channel: 'whatsapp' } };"
      },
      "id": "93009e5d-45b2-4275-9b74-c418c8323a81",
      "name": "Parse WhatsApp",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3712,
        944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.message_id }}",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.text_raw === '' && $json.interactive_id === '' }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "f3eca6b5-8a36-448b-9cc8-5821e0b74c79",
      "name": "IF Drop?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3488,
        944
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "session_id",
              "lookupValue": "={{ $json.session_id }}"
            }
          ]
        },
        "options": {
          "returnFirstMatch": true
        }
      },
      "id": "6199dcd9-2ca4-4f6d-bb2c-233bc04af180",
      "name": "Sheets Get Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3264,
        944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Parse WhatsApp').item.json;\nconst existing = $input.item.json;\n\nif (existing.last_message_id === parsed.message_id) {\n  return { json: { _stop: true } };\n}\n\nconst hasValidSession = existing.session_id \n  && existing.state \n  && existing.state.trim() !== '';\n\nconst session = hasValidSession ? existing : {\n  session_id: parsed.session_id,\n  channel: parsed.channel,\n  user_id: parsed.from,\n  state: 'NEW',\n  service_id: '',\n  doctor_id: '',\n  selected_slot_start: '',\n  selected_slot_end: '',\n  hold_event_id: '',\n  hold_expires_at: '',\n  patient_name: '',\n    tc_kimlik: '',\n    birth_year: '',\n    nvi_attempts: 0,\n    flow_type: '',\n  patient_notes: '',\n  complaint_text: '',\n  complaint_tag: '',\n  last_message_id: '',\n  updated_at: ''\n};\n\nreturn { json: { ...parsed, session } };"
      },
      "id": "2978a61f-cdfc-4d1d-aea8-09ef491609e2",
      "name": "Upsert+Idempotency",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3040,
        944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json._stop }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c18e61d7-28d9-445b-ba82-bba31f723acf",
      "name": "IF Stop?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2816,
        944
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session_id }}",
            "last_message_id": "={{ $json.message_id }}",
            "updated_at": "={{ $json.nowISO }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "5ba4035b-21c4-4754-877b-cf661a473e64",
      "name": "Sheets Upsert Session Early",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2592,
        944
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1259247302,
          "mode": "list",
          "cachedResultName": "services",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=1259247302"
        },
        "options": {}
      },
      "id": "403eb549-4d07-4d04-b9db-9d58e3e2edc6",
      "name": "Sheets Read Services",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2368,
        944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 907503429,
          "mode": "list",
          "cachedResultName": "doctors",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=907503429"
        },
        "options": {}
      },
      "id": "5bbda85b-816f-4d1e-8268-adda03ff58cc",
      "name": "Sheets Read Doctors",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2144,
        944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Parse WhatsApp').first().json;\nconst sessionData = $('Upsert+Idempotency').first().json;\n\nconst interactive_id = parsed.interactive_id || '';\nconst text_raw = parsed.text_raw || '';\n\nlet event = { kind: 'text', value: '' };\n\nif (interactive_id.startsWith('svc|')) {\n  event.kind = 'svc';\n  event.value = interactive_id.substring(4);\n} else if (interactive_id.startsWith('doc|')) {\n  event.kind = 'doc';\n  event.value = interactive_id.substring(4);\n} else if (interactive_id.startsWith('slot|')) {\n  event.kind = 'slot';\n  event.value = interactive_id;\n} else if (interactive_id.startsWith('day|')) {\n  event.kind = 'day';\n  event.value = interactive_id.substring(4);\n} else if (interactive_id === 'btn_confirm') {\n  event.kind = 'confirm';\n  event.value = 'confirm';\n} else if (interactive_id === 'btn_change') {\n  event.kind = 'change';\n  event.value = 'change';\n} else if (interactive_id === 'btn_cancel') {\n  event.kind = 'cancel';\n  event.value = 'cancel';\n} else if (interactive_id === 'btn_book') {\n  event.kind = 'book';\n  event.value = 'book';\n} else {\n  event.kind = 'text';\n  event.value = text_raw.trim();\n}\n\nconst output = {\n  message_id: parsed.message_id,\n  from: parsed.from,\n  type: parsed.type,\n  interactive_id: parsed.interactive_id || '',\n  text_raw: parsed.text_raw || '',\n  timestamp_ms: parsed.timestamp_ms,\n  nowISO: parsed.nowISO,\n  session_id: sessionData.session_id,\n  channel: sessionData.channel,\n  session: sessionData.session,\n  event: event\n};\n\nreturn [{ json: output }];"
      },
      "id": "573cc89b-d4b4-4823-8537-24a87e0f57c1",
      "name": "Derive Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1920,
        944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.service_id }}",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.event.kind }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "id-3",
              "leftValue": "={{ $json.event.value.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "932e8f4c-96a7-4f0f-8caf-679ce45bc88a",
      "name": "IF AI Triage?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1024,
        1424
      ]
    },
    {
      "parameters": {
        "jsCode": "// Google Sheets'ten gelen hizmetleri al\nconst services = $('Sheets Read Services').all().map(item => item.json);\n\n// AI için okunabilir bir liste oluştur\n// Örnek Çıktı: \"1 | Diş Çekimi | tags: ağrı, çekim\"\nconst services_lines = services.map(s => {\n    // service_id'yi zorla metne çevir (toString)\n    const id = s.service_id ? s.service_id.toString() : '';\n    const name = s.service_name || '';\n    const tags = s.complaint_tags || '';\n    return `${id} | ${name} | tags:${tags}`;\n}).join('\\n');\n\nreturn { json: { ...$input.item.json, services_lines } };"
      },
      "id": "581521c5-894f-4ab5-94d4-68a2e49b7bcb",
      "name": "Build Services Lines",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        1328
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an expert Dental Triage Assistant for a Turkish dental clinic. Your goal is to analyze the patient's complaint and generate a professional medical summary for the dentist.\n\nIMPORTANT CLINICAL RULE: You CANNOT diagnose or assign a specific treatment without a clinical examination. Your job is to:\n1. Understand the patient's symptoms\n2. Generate a medical summary in Turkish for the dentist\n3. Assess urgency (urgent/normal)\n4. Suggest a POSSIBLE treatment area (for informational purposes only)\n\nAVAILABLE SERVICES:\n{{ $json.services_lines }}\n\nPATIENT COMPLAINT:\n\"{{ $json.event.value }}\"\n\nROUTING RULES:\n- For ANY complaint involving pain, sensitivity, swelling, broken tooth, bleeding, or any symptom that requires clinical examination → ALWAYS use the \"Muayene\" (Examination/Consultation) service_id.\n- ONLY for cosmetic/hygiene requests that do NOT require diagnosis (e.g., \"diş temizliği\", \"beyazlatma\", \"check-up\", \"kontrol\") → You MAY use the specific service_id directly.\n- When in doubt, ALWAYS choose the Examination/Consultation service.\n\nOUTPUT FORMAT (JSON ONLY):\nReturn strictly valid JSON with no markdown blocks.\n{\n  \"intent\": \"book\",\n  \"service_id\": \"EXAMINATION_SERVICE_ID\",\n  \"suggested_treatment\": \"POSSIBLE_TREATMENT_SERVICE_ID_FOR_DOCTOR_REFERENCE\",\n  \"confidence\": 0.95,\n  \"urgency\": \"urgent/normal\",\n  \"medical_summary\": \"Hasta ... şikayeti ile başvurdu. Olası ... ön tanısı. Klinik muayene ve radyografik değerlendirme gereklidir.\"\n}\n\nRULES:\n- You MUST pick a 'service_id' exactly as it appears in the service list.\n- For pain/symptom complaints, ALWAYS pick the Examination/Consultation service_id.\n- 'suggested_treatment' is informational only - the dentist will decide after examination.\n- 'medical_summary' must be professional and in Turkish.\n- Include \"Klinik muayene gereklidir\" in the medical_summary for symptom-based complaints.",
        "batching": {}
      },
      "id": "5250f8e3-14e5-4462-a1ab-f3843c930e34",
      "name": "AI Triage",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.9,
      "position": [
        -576,
        1328
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "c0a99b5a-07a0-489c-962b-dc2e328d658d",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -512,
        1552
      ],
      "credentials": {
        "openAiApi": {
          "id": "aTF6iArjfhoADgrG",
          "name": "n8n free OpenAI API credits"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Verileri Al\nconst sourceData = $items('Build Services Lines')[0].json; \nconst aiResponseText = $input.item.json.text || '{}';\n\nlet ai = {};\ntry {\n  ai = JSON.parse(aiResponseText);\n} catch(e) {\n  ai = { confidence: 0, service_id: null, medical_summary: '', suggested_treatment: '' };\n}\n\n// 2. Session Güncelle\nconst session = { ...sourceData.session };\nsession.complaint_text = sourceData.event.value;\nsession.patient_notes = ai.medical_summary || '';\n\n// 3. Hizmet Eşleştirme - confidence eşiği 0.80'e yükseltildi (Fix #7)\nif (ai.confidence >= 0.80 && ai.service_id) {\n  session.service_id = ai.service_id.toString(); \n  session.state = 'SERVICE_SELECTED';\n  // suggested_treatment bilgi amaçlı sakla\n  session.complaint_tag = ai.suggested_treatment || '';\n} else {\n  session.state = 'COLLECTING';\n}\n\nsession.updated_at = new Date().toISOString();\n\nreturn { json: { ...sourceData, session, ai } };"
      },
      "id": "6e292a9b-6ea0-4858-84b6-73ecbaded5cd",
      "name": "Merge AI->Session",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        1328
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "service_id": "={{ $json.session.service_id }}",
            "complaint_text": "={{ $json.session.complaint_text }}",
            "complaint_tag": "={{ $json.session.complaint_tag }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "b060765a-546e-4a55-9122-b6c71f1715bd",
      "name": "Sheets Update Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        0,
        1328
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind.toString() }}",
                    "rightValue": "svc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a8dca4bc-a337-48ca-928a-6840f0fcad7f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Service Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session.service_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "isEmpty"
                    },
                    "id": "3557df0b-a251-4fdc-9250-f6b6c0bcbdbb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Service"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind.toString() }}",
                    "rightValue": "doc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "19a562a7-7f06-4bde-8f6a-a3f0cacf5787"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Doctor Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session.doctor_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "isEmpty"
                    },
                    "id": "0a4e9402-ca7f-42e7-a146-55d75b221254"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Doctor"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session.state.toString() }}",
                    "rightValue": "DOCTOR_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8dd5ba5d-2419-41ab-ad47-675c0fa24915"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Continue"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "8dbe5de8-e228-4a9d-908c-04420736d1c2",
      "name": "Router A",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        224,
        1376
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "service_id": "={{ $json.event.value }}",
            "state": "SERVICE_SELECTED",
            "updated_at": "={{ $json.nowISO }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "4f73deb8-3c34-43b5-bd82-a615781adcfa",
      "name": "Sheets Update Session Service",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        448,
        464
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const services = $('Sheets Read Services').all().map(item => item.json);\nconst rows = services.map(s => ({\n  id: 'svc|' + s.service_id,\n  title: s.service_name.substring(0, 24),\n  description: (s.description || '').substring(0, 72)\n}));\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'interactive',\n  interactive: {\n    type: 'list',\n    header: {\n      type: 'text',\n      text: 'Hizmet Seçin'\n    },\n    body: {\n      text: 'Hangi işlem için randevu?'\n    },\n    action: {\n      button: 'Hizmetleri Gör',\n      sections: [{\n        title: 'Available Services',\n        rows\n      }]\n    }\n  }\n};\nreturn { json: payload };"
      },
      "id": "712850c1-4577-43cd-9477-82be6fc01e3d",
      "name": "Build Services Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQq1kTXD7a2d8cPxjpMLZAqzWX90QPQcvZCf9nFgHuVXkxbSXfFy4InidGxKFEGXxT1yR0JNe8t5l21ZBPR2iKDL1BbU7bVU2mkfL9DyiNX0ZCVNmw2wZB5Qq1WFQGnUQRtLMylw7KstxvM9tVpBHR06uWuFPn5s4CjMVmBDG44TqwVvJVaFUJnD6OuNwQ8ZCPK6RlZAznl7wgOlZC1Rhr0UdSAVqsomZB9Chq04ZBT1ENASXmSxy2v89CrBF5qXIZBTvwGV3Mqcc29m"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "0c755507-6ef6-4dad-9df1-80a108f2723c",
      "name": "WA Send Services",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        672,
        656
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "doctor_id": "={{ $json.event.value }}",
            "state": "DOCTOR_SELECTED",
            "updated_at": "={{ $json.nowISO }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "863b8c57-0614-4ca2-b967-09960b8eabe6",
      "name": "Sheets Update Session Doctor",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        448,
        2048
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Girdi verilerini al\nconst items = $input.all();\nif (items.length === 0) return [];\n\n// 2. İlk item üzerinden seçili hizmet ID'sini al\nconst selected_service_id = items[0].json.session?.service_id || \"\";\n\n// 3. Sheets'ten okunan tüm doktorları çek\n// DİKKAT: 'Sheets Read Doctors' düğüm isminin n8n'de aynı olduğundan emin olun\nconst allDoctors = $('Sheets Read Doctors').all().map(i => i.json);\n\n// 4. Tekilleştirme ve Filtreleme\nconst uniqueDoctors = [];\nconst seenIds = new Set();\n\nallDoctors.forEach(doc => {\n  const docId = doc.doctor_id?.toString();\n  if (docId && !seenIds.has(docId)) {\n    // Doktorun verdiği hizmetleri ayır ve temizle\n    const doctorServices = (doc.service_ids || '').split(',').map(s => s.trim());\n    \n    // Eşleşme kontrolü\n    if (doctorServices.includes(selected_service_id)) {\n      uniqueDoctors.push(doc);\n      seenIds.add(docId);\n    }\n  }\n});\n\n// 5. Sonuç döndür (Eğer doktor bulunamazsa akışı durdurur, en güvenlisi budur)\nreturn uniqueDoctors.map(doc => ({\n  json: {\n    ...items[0].json,\n    doctor: doc\n  }\n}));"
      },
      "id": "d9d00202-7f83-4a02-b011-a81e594d6929",
      "name": "Filter Doctors",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst doctors = items.map(item => item.json.doctor);\n\n// WhatsApp limiti: Toplam satır sayısı 10'u geçemez\nconst limitedDoctors = doctors.slice(0, 10);\n\nconst rows = limitedDoctors.map(d => ({\n  id: 'doc|' + d.doctor_id,\n  title: d.doctor_name.substring(0, 24), // Karakter sınırı koruması\n  description: (d.specialization || '').substring(0, 72)\n}));\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: items[0].json.from,\n  type: 'interactive',\n  interactive: {\n    type: 'list',\n    header: { type: 'text', text: 'Doktor Seçin' },\n    body: { text: 'Şikayetinize yardımcı olabilecek doktorlarımız aşağıdadır:' },\n    action: {\n      button: 'Doktorları Gör',\n      sections: [{ title: 'Müsait Doktorlar', rows }]\n    }\n  }\n};\n\nreturn { json: payload };"
      },
      "id": "7488d4b4-3df7-43a4-a915-97180d95fa9b",
      "name": "Build Doctors Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        2240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "874f9325-a578-4c1d-a48a-3098dce9c96a",
      "name": "WA Send Doctors",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        896,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "// Doktor + süre bilgisini çöz\n// Bu node'a 2 yoldan gelinebilir:\n// 1. Router A → nested data ($json.session.doctor_id)\n// 2. Sheets Update Session Doctor → flat data ($json.doctor_id)\n\nconst data = $input.item.json;\nconst doctor_id = data.session?.doctor_id || data.doctor_id || '';\n\n// Tüm doktorları tara\nconst doctors = $('Sheets Read Doctors').all().map(i => i.json);\nconst doctor = doctors.find(d => d.doctor_id === doctor_id);\n\nif (!doctor) {\n  return { json: { ...data, error: 'Doctor not found: ' + doctor_id } };\n}\n\n// Service bilgisini bul\nconst service_id = data.session?.service_id || data.service_id || '';\nconst services = $('Sheets Read Services').all().map(i => i.json);\nconst service = services.find(s => s.service_id === service_id);\n\nconst duration_min = service?.duration_min || 30;\nconst buffer_min = service?.buffer_min || 0;\n\nreturn { json: { \n  ...data, \n  doctor, \n  service_id,\n  slot_duration_min: duration_min, \n  buffer_min,\n  calendar_id: doctor.calendar_id\n} };"
      },
      "id": "b79f541f-10f7-407f-9d0b-046645daf957",
      "name": "Resolve Doctor+Duration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        1504
      ]
    },
    {
      "parameters": {
        "jsCode": "const free_slots = $input.item.json.free_slots || [];\nconst prev = $('Resolve Doctor+Duration').first().json;\nconst doctor_id = prev.session?.doctor_id || prev.doctor_id || '';\nconst from = prev.from || prev.session?.user_id || $('Parse WhatsApp').first().json.from || '';\n\nconst maxRows = 10;\nconst limitedRows = free_slots.slice(0, maxRows).map(slot => {\n  const startDate = new Date(slot.start);\n  const hhmm = startDate.toTimeString().substring(0, 5);\n  const ddmmm = startDate.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', weekday: 'short' });\n  return {\n    id: 'slot|' + slot.start + '|' + doctor_id,\n    title: hhmm,\n    description: ddmmm\n  };\n});\n\nconst sections = [{ title: 'Uygun Saatler', rows: limitedRows }];\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'interactive',\n  interactive: {\n    type: 'list',\n    header: { type: 'text', text: 'Saat Seçin 🕐' },\n    body: { text: 'Uygun saati seçin:' },\n    action: {\n      button: 'Saatleri Gör',\n      sections\n    }\n  }\n};\nreturn { json: { ...prev, free_slots, payload } };"
      },
      "id": "ff980767-0aff-4829-a07f-0f1e57d40d9f",
      "name": "Build Slots Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3136,
        1600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "369ba870-2d34-40a3-8faf-87365a81d759",
      "name": "WA Send Slots",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3360,
        1600
      ]
    },
    {
      "parameters": {
        "jsCode": "const parsed = $input.item.json; const interactive_id = parsed.interactive_id || ''; if (!interactive_id.startsWith('slot|')) { return { json: $input.item.json }; } const parts = interactive_id.split('|'); const startISO = parts[1] || ''; const doctor_id = parts[2] || ''; const slot_duration_min = $input.item.json.slot_duration_min || 30; const endDate = new Date(new Date(startISO).getTime() + slot_duration_min * 60000); const session = { ...$input.item.json.session }; session.selected_slot_start = startISO; session.selected_slot_end = endDate.toISOString(); session.state = 'SLOT_SELECTED'; session.updated_at = parsed.nowISO; return { json: { ...$input.item.json, session } };"
      },
      "id": "55ed2822-87fc-4f7d-a5ed-d3ae9f5eabd6",
      "name": "Derive Slot Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        800
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "state": "={{ $json.session.state }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "6bc0ea74-f3b3-4829-8c15-12dcfcd62738",
      "name": "Sheets Update After Slot",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1120,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "syncforge.automation@gmail.com",
          "mode": "list",
          "cachedResultName": "syncforge.automation@gmail.com"
        },
        "start": "={{ $json.session.selected_slot_start }}",
        "end": "={{ $json.session.selected_slot_end }}",
        "additionalFields": {
          "description": "={{ 'hold|' + $json.session.session_id + '|' + $json.message_id + '|svc=' + $json.session.service_id }}",
          "showMeAs": "opaque",
          "summary": "HOLD - SyncForge Dental"
        }
      },
      "id": "a14b4a6b-0838-4cd0-ba09-cc0ab05f1712",
      "name": "Create HOLD Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1792,
        800
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const calEvent = $input.item.json; const event_id = calEvent.id || ''; const session = { ...$('Derive Slot Event').item.json.session }; session.state = 'HELD'; session.hold_event_id = event_id; const holdExpires = new Date(Date.now() + 5 * 60000); session.hold_expires_at = holdExpires.toISOString(); session.updated_at = new Date().toISOString(); return { json: { ...$('Derive Slot Event').item.json, session } };"
      },
      "id": "b967fb32-dac6-48d8-aa20-4214c1a398ac",
      "name": "Set HELD + TTL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2016,
        800
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Set HELD + TTL').first().json.session.session_id }}",
            "state": "={{ $('Set HELD + TTL').first().json.session.state }}",
            "hold_event_id": "={{ $('Set HELD + TTL').first().json.session.hold_event_id }}",
            "hold_expires_at": "={{ $('Set HELD + TTL').first().json.session.hold_expires_at }}",
            "updated_at": "={{ $('Set HELD + TTL').first().json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "dcdc1e31-d19e-4798-abf8-012765901356",
      "name": "Sheets Update HELD",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2240,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $('Parse WhatsApp').first().json.from,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    body: {\n      text: 'Randevunuz 5 dk rezerve edildi ⏱️\\nLütfen onaylayın:'\n    },\n    action: {\n      buttons: [\n        { type: 'reply', reply: { id: 'btn_confirm', title: '✅ Onayla' } },\n        { type: 'reply', reply: { id: 'btn_change', title: '🔄 Değiştir' } },\n        { type: 'reply', reply: { id: 'btn_cancel', title: '❌ İptal' } }\n      ]\n    }\n  }\n};\n\nreturn { json: payload };"
      },
      "id": "6d92f6da-0b27-4a68-a0dc-265f50adfc80",
      "name": "Build Confirm Buttons",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2464,
        800
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "0c02446b-7dea-4ca0-aefb-d2e372cdd507",
      "name": "WA Send Confirm",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2688,
        800
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "id-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "change",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "id-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "id-3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel"
            }
          ]
        },
        "options": {}
      },
      "id": "e005a4ea-dbfe-41a1-87c2-ea540fcb1436",
      "name": "Router Confirm/Change/Cancel",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1120,
        1600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.state }}",
              "rightValue": "HELD",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "id-3",
              "leftValue": "={{ new Date($json.session.hold_expires_at) > new Date() }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ef863159-e9df-4371-a860-0929445002a1",
      "name": "IF Confirm Guard",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1344,
        1456
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "value": "syncforge.automation@gmail.com",
          "mode": "list",
          "cachedResultName": "syncforge.automation@gmail.com"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "updateFields": {
          "description": "={{ 'CONFIRMED|' + $json.session.session_id + '|svc=' + $json.session.service_id + '|complaint=' + $json.session.complaint_text }}",
          "summary": "={{ 'Appointment - ' + ($json.session.patient_name || $json.from) }}"
        }
      },
      "id": "94997c57-45fc-4216-ba75-f70467e276d1",
      "name": "Confirm Event Update",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -800,
        800
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1645363573,
          "mode": "list",
          "cachedResultName": "appointments",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=1645363573"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "booking_id": "={{ $now.toISO() + '-' + Math.random().toString(36).substring(7) }}",
            "created_at": "={{ $now.toISO() }}",
            "channel": "whatsapp",
            "patient_name": "={{ $('Resolve Doctor For Confirm').first().json.session.patient_name || $('Resolve Doctor For Confirm').first().json.from }}",
            "phone": "={{ $('Resolve Doctor For Confirm').first().json.from }}",
            "complaint_text": "={{ $('Resolve Doctor For Confirm').first().json.session.complaint_text }}",
            "complaint_tag": "={{ $('Resolve Doctor For Confirm').first().json.session.complaint_tag }}",
            "service_id": "={{ $('Resolve Doctor For Confirm').first().json.session.service_id }}",
            "doctor_id": "={{ $('Resolve Doctor For Confirm').first().json.session.doctor_id }}",
            "start": "={{ $('Resolve Doctor For Confirm').first().json.session.selected_slot_start }}",
            "end": "={{ $('Resolve Doctor For Confirm').first().json.session.selected_slot_end }}",
            "status": "CONFIRMED",
            "hold_event_id": "={{ $('Resolve Doctor For Confirm').first().json.session.hold_event_id }}",
            "message_id": "={{ $('Parse WhatsApp').first().json.message_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "booking_id",
              "displayName": "booking_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "start",
              "displayName": "start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "end",
              "displayName": "end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cancelled_at",
              "displayName": "cancelled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "d2868554-3cfc-4636-838a-042b3b96c632",
      "name": "Append Appointment Ledger",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -512,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rd = $('Resolve Doctor For Confirm').first().json;\nconst session = rd.session;\nconst from = rd.from || $('Parse WhatsApp').first().json.from;\n\nconst startDate = new Date(session.selected_slot_start);\nconst dateStr = startDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });\nconst timeStr = startDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });\nconst doctorName = rd.doctor?.doctor_name || '';\n\nconst text = '\\u2705 Randevunuz onaylandi!\\n\\n'\n  + '\\ud83d\\udcc5 ' + dateStr + '\\n'\n  + '\\ud83d\\udd50 ' + timeStr + '\\n'\n  + '\\ud83d\\udc68\\u200d\\u2695\\ufe0f ' + doctorName + '\\n'\n  + '\\ud83d\\udc64 ' + (session.patient_name || '') + '\\n\\n'\n  + 'Gorusmek uzere! \\ud83e\\uddb7';\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: text }\n};\nreturn { json: payload };"
      },
      "id": "4aca2fb1-050b-4d3c-948a-1afaf3c2f2ec",
      "name": "Build Final Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        1088
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "c332ff55-fff2-4722-b274-cf12335afcec",
      "name": "WA Send Final",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        1088
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.interactive_id && $json.interactive_id.startsWith('slot|') }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "id-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Slot Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.session && $json.session.state === 'DOCTOR_SELECTED' && (!$json.interactive_id || !$json.interactive_id.startsWith('slot|')) }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "id-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Show Slots"
            }
          ]
        },
        "options": {}
      },
      "id": "9acaa056-89c0-42db-9b7b-174fbd6b6308",
      "name": "Router B1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        448,
        1600
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $('Sheets Read Doctors').all().map(i=>i.json); const sid = $json.session?.doctor_id || $json.event?.doctor_id || ''; const doc = doctors.find(d => d.doctor_id === sid); if(!doc) return [{json:{...$json,_stop:true,reason:'doctor_not_found_for_hold'}}]; return [{json:{...$json, doctor:doc}}];"
      },
      "id": "e50c1b4f-e4b6-4fb6-8237-6a145b9a0147",
      "name": "Resolve Doctor For Hold",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        736
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $('Sheets Read Doctors').all().map(i => i.json);\nconst session = $('Store Patient Notes').first().json.session;\n\nif (!session || !session.doctor_id) {\n  return [{ json: { _stop: true, reason: 'Session verisi bulunamadi' } }];\n}\n\nconst doc = doctors.find(d => d.doctor_id === session.doctor_id);\nif (!doc) {\n  return [{ json: { _stop: true, reason: 'Doktor bulunamadi: ' + session.doctor_id } }];\n}\n\nconst from = $('Parse WhatsApp').first().json.from;\nreturn [{ json: { session, doctor: doc, from } }];"
      },
      "id": "ca856a97-6faa-4d30-ae45-51427be71736",
      "name": "Resolve Doctor For Confirm",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        800
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json._stop }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c2336783-0a55-46c0-9f25-af2531f14ed4",
      "name": "IF Stop Hold",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1568,
        736
      ]
    },
    {
      "parameters": {
        "resource": "calendar",
        "calendar": {
          "__rl": true,
          "value": "syncforge.automation@gmail.com",
          "mode": "list",
          "cachedResultName": "syncforge.automation@gmail.com"
        },
        "timeMin": "={{ $now.toISO() }}",
        "timeMax": "={{ $now.plus({days: 7}).toISO() }}",
        "options": {}
      },
      "id": "6bdd0c9d-6771-456a-a895-bf7a269c5d6b",
      "name": "Fetch Calendar Freebusy",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        2464,
        1504
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const slot_duration_min = $input.item.json.slot_duration_min || 30;\nconst buffer_min = $input.item.json.buffer_min || 0;\nconst total_slot_min = slot_duration_min + buffer_min;\n\n// Get busy intervals from calendar freebusy response\nconst freebusyData = $input.item.json;\nlet busyIntervals = [];\nif (freebusyData.busy) {\n  busyIntervals = freebusyData.busy;\n} else if (freebusyData.calendars) {\n  const calId = Object.keys(freebusyData.calendars)[0];\n  if (calId) busyIntervals = freebusyData.calendars[calId].busy || [];\n}\n\nconst busyTimes = busyIntervals.map(interval => ({\n  start: new Date(interval.start),\n  end: new Date(interval.end)\n}));\n\nfunction isSlotBusy(slotStart, slotEnd) {\n  return busyTimes.some(busy => (slotStart < busy.end && slotEnd > busy.start));\n}\n\n// FIX #8: Türkiye timezone'u kullan\nfunction getTurkeyDate(baseDate) {\n  const turkeyStr = baseDate.toLocaleString('en-US', { timeZone: 'Europe/Istanbul' });\n  return new Date(turkeyStr);\n}\n\nconst free_slots = [];\nconst nowUTC = new Date();\nconst nowTurkey = getTurkeyDate(nowUTC);\n\nfor (let day = 0; day < 7; day++) {\n  // Türkiye saatiyle 10:00 başlat\n  const dayStart = new Date(nowTurkey);\n  dayStart.setDate(dayStart.getDate() + day);\n  dayStart.setHours(10, 0, 0, 0);\n  \n  const dayEnd = new Date(dayStart);\n  dayEnd.setHours(18, 0, 0, 0);\n  \n  // Türkiye saatini UTC'ye çevir (Google Calendar UTC kullanır)\n  const offsetMs = nowTurkey.getTime() - nowUTC.getTime();\n  \n  let cursor = new Date(dayStart.getTime() - offsetMs); // UTC karşılığı\n  const endUTC = new Date(dayEnd.getTime() - offsetMs);\n  \n  // Geçmiş slotları atla\n  if (cursor < nowUTC) {\n    // Şu anki saatten sonraki ilk slot'a atla\n    const msSinceDayStart = nowUTC.getTime() - cursor.getTime();\n    const slotsToSkip = Math.ceil(msSinceDayStart / (total_slot_min * 60000));\n    cursor = new Date(cursor.getTime() + slotsToSkip * total_slot_min * 60000);\n  }\n  \n  while (cursor < endUTC) {\n    const slotStart = new Date(cursor);\n    const slotEnd = new Date(cursor.getTime() + total_slot_min * 60000);\n    \n    if (slotEnd <= endUTC && !isSlotBusy(slotStart, slotEnd)) {\n      free_slots.push({\n        start: slotStart.toISOString(),\n        end: new Date(slotStart.getTime() + slot_duration_min * 60000).toISOString()\n      });\n    }\n    \n    cursor.setTime(cursor.getTime() + total_slot_min * 60000);\n    if (free_slots.length >= 20) break;\n  }\n  \n  if (free_slots.length >= 20) break;\n}\n\nreturn { json: { ...$input.item.json, free_slots } };"
      },
      "id": "9dbbc55b-4d23-4255-a68e-a69f66511ed8",
      "name": "Generate Real Slots from Freebusy",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2688,
        1504
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "options": {}
      },
      "id": "4068fd36-be6c-4e6c-9642-256c63007743",
      "name": "Delete Hold Event (Change)",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1568,
        1136
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$('Router Confirm/Change/Cancel').item.json.session };\nsession.state = 'DOCTOR_SELECTED';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$('Router Confirm/Change/Cancel').item.json, session } };"
      },
      "id": "2f3be327-aadb-4ce9-8736-69f3b4e10cf3",
      "name": "Reset Session for Change",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1216
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "hold_expires_at": "={{ $json.session.hold_expires_at }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "8fac5528-080e-4d96-9819-b3639f0c9f78",
      "name": "Update Session After Change",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2016,
        1216
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "42aa9cb6-1f55-424d-af1a-6eb514dbf9a0",
      "name": "IF Hold Exists (Change)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1344,
        1216
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "options": {}
      },
      "id": "e0f5a287-3324-4953-9c28-9d6c3a4eea95",
      "name": "Delete Hold Event (Cancel)",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1568,
        1648
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$('Router Confirm/Change/Cancel').item.json.session };\nconst hold_event_id_backup = session.hold_event_id || '';\nsession.state = 'NEW';\nsession.service_id = '';\nsession.doctor_id = '';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.patient_name = '';\nsession.complaint_text = '';\nsession.complaint_tag = '';\nsession.last_message_id = '';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$('Router Confirm/Change/Cancel').item.json, session, hold_event_id_backup } };"
      },
      "id": "ef8cb528-17b9-4a7c-abbc-55c20e5383f3",
      "name": "Reset Session for Cancel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1712
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "service_id": "={{ $json.session.service_id }}",
            "doctor_id": "={{ $json.session.doctor_id }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "hold_expires_at": "={{ $json.session.hold_expires_at }}",
            "complaint_text": "={{ $json.session.complaint_text }}",
            "complaint_tag": "={{ $json.session.complaint_tag }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "0f0e52e2-6abb-49ab-9b9f-ea1a68f31dfa",
      "name": "Update Session After Cancel",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2016,
        1712
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "97f41e18-4a40-4602-86e1-a4d82c9f5884",
      "name": "WA Send Cancel Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2688,
        2000
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $('Parse WhatsApp').first().json.from,\n  type: 'text',\n  text: {\n    body: 'Randevunuz iptal edildi. ❌\\nYeni randevu için yazabilirsiniz.'\n  }\n};\nreturn { json: payload };"
      },
      "id": "9edefce0-6d57-4047-ae4c-9784fb643d45",
      "name": "Build Cancel Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2464,
        2000
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "78199475-55e9-4649-93b5-4c4e88dbf0ef",
      "name": "IF Hold Exists (Cancel)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1344,
        1712
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.session.state }}",
              "rightValue": "HELD",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "id-2",
              "leftValue": "={{ $json.session.hold_event_id }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "id-3",
              "leftValue": "={{ new Date($json.session.hold_expires_at) < new Date() }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e98bb0ce-a4cd-461d-a74b-071fad600d3d",
      "name": "IF Hold Expired",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        672,
        1904
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.session.hold_event_id }}",
        "options": {}
      },
      "id": "e9528ba9-b46b-4ca1-b525-98369d28577c",
      "name": "Delete Expired Hold",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1120,
        1952
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "PXZaipL0cjog7tKc",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nsession.state = 'DOCTOR_SELECTED';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$input.item.json, session } };"
      },
      "id": "1ab06fbc-e1ec-4159-9455-cd8342b0babd",
      "name": "Reset Session After Expiry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        1952
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "selected_slot_start": "={{ $json.session.selected_slot_start }}",
            "selected_slot_end": "={{ $json.session.selected_slot_end }}",
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "hold_expires_at": "={{ $json.session.hold_expires_at }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "9b3f1a1a-e94d-4077-ac03-33013ba6ef52",
      "name": "Update Session After Expiry",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1568,
        1952
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "3c664f2f-c242-45c7-a4e2-d53da3d5176b",
      "name": "WA Send Expiry Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2016,
        1952
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $('Parse WhatsApp').first().json.from,\n  type: 'text',\n  text: {\n    body: 'Rezervasyon süresi doldu ⏰\\nYeni saat seçin:'\n  }\n};\nreturn { json: payload };"
      },
      "id": "a946f015-853c-4980-8c29-a9ca3ae83a0a",
      "name": "Build Expiry Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1952
      ]
    },
    {
      "parameters": {
        "jsCode": "const doctors = $('Sheets Read Doctors').all().map(item => item.json);\nconst session = $input.item.json.session || {};\nconst doctor_id = session.doctor_id || '';\nconst doctor = doctors.find(d => d.doctor_id === doctor_id);\n\nif (!doctor) {\n  return [{ json: { ...$input.item.json, _stop: true, reason: 'doctor_not_found_for_expiry' } }];\n}\n\nreturn [{ json: { ...$input.item.json, doctor } }];"
      },
      "id": "11b75a32-ec74-4555-8b0c-f246a767a250",
      "name": "Resolve Doctor For Expiry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        1952
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "rnc-0a",
                    "leftValue": "={{ $json.session.patient_name }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Name Provided"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "rnc-1a",
                    "leftValue": "={{ $json.session.patient_name }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Name"
            }
          ]
        },
        "options": {}
      },
      "id": "315433fb-fbfa-48c9-8b8b-d6717fda469a",
      "name": "Router Name Collection",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1568,
        1456
      ]
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session }; session.state = 'AWAITING_NAME'; session.updated_at = new Date().toISOString(); const payload = { messaging_product: 'whatsapp', to: $input.item.json.from, type: 'text', text: { body: 'Harika! Randevu için ad soyadınızı yazar mısınız?' } }; return { json: { ...$input.item.json, session, payload } };"
      },
      "id": "f9deee5b-707f-41ba-85df-af4b9d214a77",
      "name": "Build Name Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        1456
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Build Name Request').first().json.payload) }}",
        "options": {}
      },
      "id": "ab9b6b53-f6d8-4e8c-9181-260b97804207",
      "name": "WA Send Name Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2240,
        1808
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "state": "={{ $json.session.state }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "2ad93c25-e4a6-43aa-b889-e67be90176b4",
      "name": "Update Session With Name",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1280,
        608
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "AWAITING_NAME",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "16c5ff93-4465-4853-bcc4-95052e46b73c",
      "name": "Sheets Update AWAITING_NAME",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2016,
        1456
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.free_slots.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f4784e69-936c-480e-95d0-3b9123be41f5",
      "name": "IF No Slots?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2912,
        1504
      ]
    },
    {
      "parameters": {
        "jsCode": "return { json: { messaging_product: 'whatsapp', to: $('Parse WhatsApp').first().json.from, type: 'text', text: { body: 'Maalesef 7 gün içinde müsait randevu yok 😔\\nBizi arayın veya başka doktor seçin.' } } };"
      },
      "id": "9ae2cb88-f9ce-4be2-8c40-57b3023ac38a",
      "name": "Build No Slots Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3136,
        1408
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "7014bce1-435f-4685-bcb3-dcebbd5285b3",
      "name": "WA Send No Slots",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3360,
        1408
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "6d9cf374",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "b06c0c06",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "book",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Book"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "1531ca7b",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "8703a654",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "change",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "45765fc1",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "972cc0ab",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Cancel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "b730ba7d",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "d8f70465",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "0e2db773",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_TC",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "4e593379",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TC Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d488549a",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_FULLNAME",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "9d6f8c2a",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Fullname Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "9f6f22e2",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_BIRTH_YEAR",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "f670e166",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Birth Year Input"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "98c23746",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_NAME",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "051b0116",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Name Response"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "12f61f81",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "AWAITING_NOTES",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "00261919",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Notes Response"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "293bf016",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "NEW",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "611328ad",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Welcome New"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "49014eae",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "HELD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "6bd284b5",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELD Confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "51f38a78",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "HELD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "522ed4c5",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "change",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELD Change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "df9f97db",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "HELD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "14c60041",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HELD Cancel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "7dad0179",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "DOCTOR_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "373ba0cc",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "slot",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Slot Selection"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "c5b98624",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "DOCTOR_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "9d05aed8",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Doctor Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "0429595e",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "COLLECTING",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Collecting"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "dddeb887",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "SERVICE_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "aef1e6bc",
                    "leftValue": "={{ $json.event.kind }}",
                    "rightValue": "doc",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Doctor From Service"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "528b991d",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "SERVICE_SELECTED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Service Ask Doctor"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "68ada889",
                    "leftValue": "={{ $json.session.state }}",
                    "rightValue": "CONFIRMED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Already Confirmed"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "305b1542",
                    "leftValue": "={{ true }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Default Fallback"
            }
          ]
        },
        "options": {}
      },
      "id": "09b3491c-495a-4976-95a1-00b7a79765c7",
      "name": "Router State Handler Updated",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -1696,
        912
      ]
    },
    {
      "parameters": {
        "jsCode": "const from = $input.item.json.from || $('Parse WhatsApp').first().json.from;\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'interactive',\n  interactive: {\n    type: 'button',\n    header: { type: 'text', text: '🦷 SyncForge Dental' },\n    body: { text: 'Hoş geldiniz! Size nasıl yardımcı olabilirim?' },\n    action: {\n      buttons: [\n        { type: 'reply', reply: { id: 'btn_book', title: '📅 Randevu Al' } },\n        { type: 'reply', reply: { id: 'btn_change', title: '🔄 Değiştir' } },\n        { type: 'reply', reply: { id: 'btn_cancel', title: '❌ İptal' } }\n      ]\n    }\n  }\n};\nreturn { json: { ...$input.item.json, payload } };"
      },
      "id": "c304289f-7613-488f-b871-f0e4144bcd2b",
      "name": "Build Welcome",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        1360
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "c922f729-1c7d-456a-bb54-484530feb68f",
      "name": "WA Send Welcome",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1248,
        1360
      ]
    },
    {
      "parameters": {
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst session = { ...$input.item.json.session };\nsession.state = 'AWAITING_NOTES';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: {\n    body: 'Teşekkürler! 📝\\nDoktora iletmek istediğiniz not var mı?\\n(Yazın veya \"geç\" yazarak devam edin)'\n  }\n};\n\nreturn { json: { ...$input.item.json, session, payload } };"
      },
      "id": "85d130cf-368c-4815-bbd8-226e73eba67c",
      "name": "Build Notes Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        608
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "5c77caa6-539e-4737-9853-8e77a357fbdb",
      "name": "WA Send Notes Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -800,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nconst rawNotes = ($input.item.json.text_raw || '').trim();\n\nif (rawNotes.toLowerCase() === 'geç' || rawNotes.toLowerCase() === 'yok' || rawNotes === '-') {\n  session.patient_notes = session.patient_notes || 'Hasta ek not belirtmedi.';\n} else {\n  const existingNotes = session.patient_notes || '';\n  session.patient_notes = existingNotes ? existingNotes + '\\nHasta notu: ' + rawNotes : rawNotes;\n}\n\nsession.state = 'CONFIRMED';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$input.item.json, session } };"
      },
      "id": "bf6ef87a-46c3-46b7-af76-554fb67a6be8",
      "name": "Store Patient Notes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        800
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "patient_notes": "={{ $json.session.patient_notes }}",
            "state": "={{ $json.session.state }}",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "c079ff22-8585-44f7-9018-34f51548a1a7",
      "name": "Sheets Update Notes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1248,
        800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nconst rawName = ($input.item.json.text_raw || '').trim();\n\nconst cleanName = rawName.replace(/[^a-zA-ZçÇğĞıİöÖşŞüÜ\\s]/g, '').trim();\n\nif (cleanName.length < 2) {\n  session.state = 'AWAITING_NAME';\n  session.updated_at = new Date().toISOString();\n  return { json: { ...$input.item.json, session, _invalid_name: true } };\n}\n\nsession.patient_name = cleanName;\nsession.state = 'AWAITING_NOTES';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...$input.item.json, session } };"
      },
      "id": "5f1d5be2-a0ae-4ee4-8aba-0afc823986a5",
      "name": "Store Patient Name Updated",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const rd = $('Resolve Doctor For Confirm').first().json;\nconst s = rd.session;\nconst d = rd.doctor;\n\nif (!d || !d.phone) return [];\n\nconst txt = '\\ud83d\\udccb Yeni Randevu!\\n\\n'\n  + '\\ud83d\\udc64 Hasta: ' + (s.patient_name || 'Belirtilmedi') + '\\n'\n  + '\\ud83d\\udcde Telefon: ' + (rd.from || '') + '\\n'\n  + '\\ud83d\\udcc5 Tarih: ' + new Date(s.selected_slot_start).toLocaleDateString('tr-TR') + '\\n'\n  + '\\ud83d\\udd50 Saat: ' + new Date(s.selected_slot_start).toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'}) + '\\n'\n  + '\\ud83d\\udcac Sikayet: ' + (s.complaint_text || '-') + '\\n'\n  + '\\ud83d\\udcdd Not: ' + (s.patient_notes || '-');\n\nreturn { json: { messaging_product: 'whatsapp', to: d.phone, type: 'text', text: { body: txt } } };"
      },
      "id": "283563f4-ab1f-4e82-a9de-f51fe0dfa76c",
      "name": "Build Doctor WA Notify",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        704
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "09e8c90c-8d26-42d3-bb1c-c42c7b4c4b27",
      "name": "WA Send Doctor Notify",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        704
      ]
    },
    {
      "parameters": {
        "jsCode": "const rd = $('Resolve Doctor For Confirm').first().json;\nconst s = rd.session;\nconst d = rd.doctor;\nif (!d.phone) return [];\nreturn { json: { phone: d.phone, message: 'Yeni Randevu: ' + s.patient_name + ' - ' + s.selected_slot_start } };"
      },
      "id": "96ba7426-e6c4-4311-94df-444dc8a0cb7d",
      "name": "Build Doctor SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        896
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.netgsm.com.tr/sms/send/get",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "usercode",
              "value": "<__PLACEHOLDER_VALUE__USERCODE__>"
            },
            {
              "name": "password",
              "value": "<__PLACEHOLDER_VALUE__PASSWORD__>"
            },
            {
              "name": "gsmno",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.message }}"
            }
          ]
        },
        "options": {}
      },
      "id": "be1a1a0d-e639-4404-b74a-cd966f0b2d78",
      "name": "Send SMS Netgsm",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        896
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1645363573,
          "mode": "list",
          "cachedResultName": "appointments",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=1645363573"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "hold_event_id": "={{ $json.session.hold_event_id }}",
            "status": "CANCELLED",
            "cancelled_at": "={{ $now.toISO() }}",
            "row_number": 0
          },
          "matchingColumns": [
            "hold_event_id"
          ],
          "schema": [
            {
              "id": "booking_id",
              "displayName": "booking_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "start",
              "displayName": "start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "end",
              "displayName": "end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cancelled_at",
              "displayName": "cancelled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "9a364a3c-74a1-4c33-a50f-f723f4751d09",
      "name": "Update Appointment Cancelled",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2240,
        2000
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "emremengir@gmail.com",
        "subject": "=Yeni Randevu Onaylandı - {{ $('Resolve Doctor For Confirm').item.json.session.patient_name || 'Hasta' }}",
        "emailType": "text",
        "message": "=Sayın Doktor,\n\nYeni bir randevu oluşturuldu:\n--------------------------------\n👤 Hasta: {{ $('Resolve Doctor For Confirm').item.json.session.patient_name }}\n📞 Telefon: {{ $('Resolve Doctor For Confirm').item.json.from }}\n📝 Şikayet: {{ $('Resolve Doctor For Confirm').item.json.session.complaint_text }}\n📅 Tarih/Saat: {{ $('Resolve Doctor For Confirm').item.json.session.selected_slot_start }}\n--------------------------------\n\nLütfen takviminizi kontrol ediniz.",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        -304,
        800
      ],
      "id": "11c28429-93ad-448a-90d8-b7fb0ba42ad6",
      "name": "Send a message",
      "webhookId": "7366e9a0-3f64-4768-bf93-f1f4950a6c46",
      "credentials": {
        "gmailOAuth2": {
          "id": "cW17YBtpA6glF504",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "gid=0",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Build Welcome').first().json.session.session_id }}",
            "state": "INIT",
            "updated_at": "={{ $now.toISO() }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        3648,
        1264
      ],
      "id": "5f2a9761-fc1d-4f2a-81d7-44fb002d0593",
      "name": "Update State After Welcome",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = { ...$input.item.json.session };\nconst holdEventId = session.hold_event_id || '';\n\n// Session'ı DOCTOR_SELECTED'a geri al\nsession.state = 'DOCTOR_SELECTED';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'text',\n  text: {\n    body: '⏰ Rezervasyon süreniz dolmuş.\\nEndişelenmeyin, yeni saatler yükleniyor...'\n  }\n};\n\nreturn { json: { ...$input.item.json, session, payload, expired_hold_event_id: holdEventId } };"
      },
      "id": "5c2f63a0-4f74-4fed-9dbc-4abb96687c65",
      "name": "Handle Expired On Confirm",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        1664
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "id": "92ca36b7-37e8-4341-bcdd-fc407ceb5681",
      "name": "WA Send Expired Confirm Msg",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1936,
        1664
      ]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "selected_slot_start": "",
            "selected_slot_end": "",
            "hold_event_id": "",
            "hold_expires_at": "",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "d1c22317-7581-4c1e-a8fa-a4ca337a6bba",
      "name": "Sheets Update Expired Confirm",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2240,
        1664
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.doctor.calendar_id }}"
        },
        "eventId": "={{ $json.expired_hold_event_id }}",
        "options": {}
      },
      "id": "d9e2e9d0-5acf-4349-86cc-9443bc5558df",
      "name": "Delete Expired Hold On Confirm",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1936,
        1856
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Resolve Doctor For Confirm').first().json.session.session_id }}",
            "state": "CONFIRMED",
            "updated_at": "={{ $now.toISO() }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "7e23e182-fa14-4d21-84b5-b21306a9c887",
      "name": "Sheets Set CONFIRMED",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -208,
        960
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "fix5-1",
              "leftValue": "={{ $json.session.hold_event_id_backup || '' }}",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0107bf22-65ba-4379-b2bd-fdea6220dc38",
      "name": "IF Ledger Entry Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1984,
        2000
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "fix10-1",
              "leftValue": "={{ $json._invalid_name }}",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5427cc5a-6ffd-48e3-a24c-0df61432fb76",
      "name": "IF Invalid Name",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1168,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'text',\n  text: { body: 'Lütfen geçerli bir ad soyad giriniz. 🙏\\nÖrnek: Ahmet Yılmaz' }\n};\nreturn { json: payload };"
      },
      "id": "d45b0962-5fbe-4f62-976c-30dd16fe660c",
      "name": "Build Retry Name Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        512
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "d1f1db1a-0446-47cd-b6cc-ae36c87e1c19",
      "name": "WA Send Retry Name",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = {\n  messaging_product: 'whatsapp',\n  to: $input.item.json.from,\n  type: 'text',\n  text: {\n    body: '✅ Zaten onaylanmış bir randevunuz var!\\n\\nRandevunuzu değiştirmek veya iptal etmek için kliniği arayabilirsiniz.\\n📞 İletişim için: (klinik telefonu)'\n  }\n};\nreturn { json: payload };"
      },
      "id": "d6d4047c-573c-4023-a6a3-a12c99aa063c",
      "name": "Build Already Confirmed Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        1712
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "e89e12fd-781f-4fd0-9caa-a13397a27ce8",
      "name": "WA Send Already Confirmed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -992,
        1712
      ]
    },
    {
      "parameters": {
        "jsCode": "const original = $('Merge AI->Session').first().json;\nreturn { json: original };"
      },
      "id": "1bf1e948-0f06-4db6-ae9e-3912f1f3dfc2",
      "name": "Restore Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        1328
      ]
    },
    {
      "parameters": {
        "jsCode": "const original = $('Build Welcome').first().json;\nconst session = { ...original.session };\nsession.state = 'COLLECTING';\nsession.updated_at = new Date().toISOString();\nreturn { json: { ...original, session } };"
      },
      "id": "5924ea3e-2ca5-4c68-8c29-583f6fa604d1",
      "name": "Restore Welcome Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        1264
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst session = { ...$input.item.json.session };\n\n// Yeni randevu — tüm eski verileri sıfırla\nsession.state = 'AWAITING_TC';\nsession.flow_type = 'book';\nsession.nvi_attempts = 0;\nsession.tc_kimlik = '';\nsession.patient_name = '';\nsession.birth_year = '';\nsession.service_id = '';\nsession.doctor_id = '';\nsession.complaint_text = '';\nsession.complaint_tag = '';\nsession.patient_notes = '';\nsession.selected_slot_start = '';\nsession.selected_slot_end = '';\nsession.hold_event_id = '';\nsession.hold_expires_at = '';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '🆔 Lütfen TC Kimlik numaranızı girin (11 hane):' }\n};\n\nreturn { json: { ...$input.item.json, session, payload } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        720
      ],
      "id": "98e113a0-ba1d-4a41-8d5d-28da144f4cc8",
      "name": "Handle Book Button"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "flow_type": "={{ $json.session.flow_type }}",
            "nvi_attempts": "0",
            "tc_kimlik": "",
            "patient_name": "",
            "birth_year": "",
            "service_id": "",
            "doctor_id": "",
            "complaint_text": "",
            "complaint_tag": "",
            "patient_notes": "",
            "selected_slot_start": "",
            "selected_slot_end": "",
            "hold_event_id": "",
            "hold_expires_at": "",
            "updated_at": "={{ $json.session.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1200,
        720
      ],
      "id": "d9b457f0-28c8-4b4a-824b-11360391d6e7",
      "name": "Sheets Update AWAITING_TC",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Handle Book Button').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        720
      ],
      "id": "b2b299bf-b46f-4522-a183-2343df6cd706",
      "name": "WA Send TC Request"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst tc = ($input.item.json.text_raw || '').trim();\nconst session = { ...$input.item.json.session };\n\n// TC Kimlik algoritma doğrulaması\nfunction validateTC(tc) {\n  if (!/^\\d{11}$/.test(tc)) return false;\n  if (tc[0] === '0') return false;\n  const d = tc.split('').map(Number);\n  const odd = d[0] + d[2] + d[4] + d[6] + d[8];\n  const even = d[1] + d[3] + d[5] + d[7];\n  if ((odd * 7 - even) % 10 !== d[9]) return false;\n  if (d.slice(0, 10).reduce((a, b) => a + b, 0) % 10 !== d[10]) return false;\n  return true;\n}\n\nconst isValid = validateTC(tc);\n\nif (isValid) {\n  session.tc_kimlik = tc;\n  session.state = 'AWAITING_FULLNAME';\n  session.updated_at = new Date().toISOString();\n  \n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '✅ TC doğrulandı.\\nLütfen adınızı ve soyadınızı girin:' }\n  };\n  return { json: { ...$input.item.json, session, payload, tc_valid: true } };\n} else {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '❌ Geçersiz TC Kimlik numarası.\\nLütfen 11 haneli TC numaranızı tekrar girin:' }\n  };\n  return { json: { ...$input.item.json, session, payload, tc_valid: false } };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        528
      ],
      "id": "adc59489-0593-4ea8-8d0d-03e24f17b13b",
      "name": "Process TC Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "tc1",
              "leftValue": "={{ $json.tc_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1200,
        528
      ],
      "id": "92f5b905-3708-46ad-b72b-8eee1dcdb7a7",
      "name": "IF TC Valid?"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "tc_kimlik": "={{ $json.session.tc_kimlik }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -960,
        464
      ],
      "id": "38f3edc7-9bf5-4927-b6ad-8b07c9369cb5",
      "name": "Sheets Update AWAITING_FULLNAME",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process TC Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        464
      ],
      "id": "ae871e3e-47c4-443c-be56-7dfa43e48706",
      "name": "WA Send TC Flow"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process TC Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        592
      ],
      "id": "1e8a9fde-2932-4155-b624-1b5b8f75dc31",
      "name": "WA Send TC Error"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst fullname = ($input.item.json.text_raw || '').trim();\nconst session = { ...$input.item.json.session };\n\nif (fullname.length < 3 || !fullname.includes(' ')) {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '❌ Lütfen adınızı ve soyadınızı boşlukla ayırarak girin:\\nÖrnek: Emre Mengir' }\n  };\n  return { json: { ...$input.item.json, session, payload, name_valid: false } };\n}\n\nsession.patient_name = fullname;\nsession.state = 'AWAITING_BIRTH_YEAR';\nsession.updated_at = new Date().toISOString();\n\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '📅 Doğum yılınızı girin (4 hane):\\nÖrnek: 1990' }\n};\n\nreturn { json: { ...$input.item.json, session, payload, name_valid: true } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        320
      ],
      "id": "ea1c08b6-22f4-4102-9517-9c8849c7f8c8",
      "name": "Process Fullname Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "nm1",
              "leftValue": "={{ $json.name_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1200,
        320
      ],
      "id": "c43a7d97-b038-45bb-ace4-6c7b2a30de40",
      "name": "IF Name Valid?"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -960,
        272
      ],
      "id": "3842b6e2-f771-4a1a-b946-492177e85cda",
      "name": "Sheets Update AWAITING_BIRTH_YEAR",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process Fullname Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        272
      ],
      "id": "30f3053d-63ef-48c2-9066-7dea115f98b9",
      "name": "WA Send Name Flow"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process Fullname Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        384
      ],
      "id": "b42ee2fe-6dbb-481b-b061-0440b959c1ea",
      "name": "WA Send Name Error"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst yearStr = ($input.item.json.text_raw || '').trim();\nconst session = { ...$input.item.json.session };\nconst year = parseInt(yearStr);\n\nif (!/^\\d{4}$/.test(yearStr) || year < 1920 || year > 2010) {\n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '❌ Geçersiz doğum yılı.\\nLütfen 4 haneli doğum yılınızı girin (örn: 1990):' }\n  };\n  return { json: { ...$input.item.json, session, payload, year_valid: false } };\n}\n\nsession.birth_year = yearStr;\nsession.updated_at = new Date().toISOString();\n\n// NVI SOAP request için Türkçe uppercase dönüşüm\nconst nameParts = (session.patient_name || '').toUpperCase()\n  .replace(/I/g, 'İ')  // Türkçe İ düzeltmesi\n  .split(' ');\n\nconst ad = nameParts.slice(0, -1).join(' ') || nameParts[0] || '';\nconst soyad = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';\n\nconst soapXml = '<?xml version=\"1.0\" encoding=\"utf-8\"?>' +\n  '<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">' +\n  '<soap:Body>' +\n  '<TCKimlikNoDogrula xmlns=\"http://tckimlik.nvi.gov.tr/WS\">' +\n  '<TCKimlikNo>' + session.tc_kimlik + '</TCKimlikNo>' +\n  '<Ad>' + ad + '</Ad>' +\n  '<Soyad>' + soyad + '</Soyad>' +\n  '<DogumYili>' + session.birth_year + '</DogumYili>' +\n  '</TCKimlikNoDogrula>' +\n  '</soap:Body></soap:Envelope>';\n\nreturn { json: { ...$input.item.json, session, soapXml, year_valid: true, from } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        128
      ],
      "id": "d3cf6f1e-35ad-472d-9094-d55fee025183",
      "name": "Process Birth Year Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "yr1",
              "leftValue": "={{ $json.year_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1200,
        128
      ],
      "id": "ba898cb3-b934-4cce-8c11-1e24f38564e1",
      "name": "IF Year Valid?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Process Birth Year Input').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        192
      ],
      "id": "fd5ce40d-7dd6-4415-8ba2-5f1eac427fb2",
      "name": "WA Send Year Error"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tckimlik.nvi.gov.tr/Service/KPSPublic.asmx",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "text/xml; charset=utf-8"
            },
            {
              "name": "SOAPAction",
              "value": "http://tckimlik.nvi.gov.tr/WS/TCKimlikNoDogrula"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "text/xml",
        "body": "={{ $json.soapXml }}",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        64
      ],
      "id": "7a761976-cffc-499c-bec5-c39fd79cc93c",
      "name": "NVI SOAP Call"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst session = $('Process Birth Year Input').first().json.session;\nconst responseText = $input.item.json.data || $input.item.json.body || JSON.stringify($input.item.json);\n\n// SOAP yanıtından true/false çıkar\nconst isValid = responseText.includes('>true<') || responseText.includes('true</');\n\nif (isValid) {\n  session.state = 'COLLECTING';\n  session.updated_at = new Date().toISOString();\n  \n  const payload = {\n    messaging_product: 'whatsapp',\n    to: from,\n    type: 'text',\n    text: { body: '✅ Kimlik doğrulandı!\\nHoş geldiniz ' + session.patient_name + '! 🦷\\n\\nŞimdi şikayetinizi veya hangi işlem için geldiğinizi yazın.\\n\\nÖrnek: \"Diş ağrısı\" veya \"Diş temizliği\"' }\n  };\n  \n  return { json: { ...$input.item.json, session, payload, nvi_valid: true } };\n} else {\n  session.nvi_attempts = (parseInt(session.nvi_attempts) || 0) + 1;\n  const maxAttempts = 3;\n  \n  if (session.nvi_attempts >= maxAttempts) {\n    session.state = 'INIT';\n    session.tc_kimlik = '';\n    session.patient_name = '';\n    session.birth_year = '';\n    session.updated_at = new Date().toISOString();\n    \n    const payload = {\n      messaging_product: 'whatsapp',\n      to: from,\n      type: 'text',\n      text: { body: '❌ Kimlik bilgileri 3 kez doğrulanamadı.\\nLütfen kliniğimizi arayarak randevu alabilirsiniz.\\n📞 (0332) XXX XX XX' }\n    };\n    return { json: { ...$input.item.json, session, payload, nvi_valid: false } };\n  } else {\n    session.state = 'AWAITING_TC';\n    session.tc_kimlik = '';\n    session.patient_name = '';\n    session.birth_year = '';\n    session.updated_at = new Date().toISOString();\n    \n    const payload = {\n      messaging_product: 'whatsapp',\n      to: from,\n      type: 'text',\n      text: { body: '❌ Bilgiler eşleşmedi (Deneme ' + session.nvi_attempts + '/3).\\nLütfen TC Kimlik numaranızı tekrar girin:' }\n    };\n    return { json: { ...$input.item.json, session, payload, nvi_valid: false } };\n  }\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        64
      ],
      "id": "a4f40440-1fa8-4370-b03a-9a8ca1c30d50",
      "name": "Parse NVI Response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "nvi1",
              "leftValue": "={{ $json.nvi_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -240,
        64
      ],
      "id": "dcae53cd-1d01-4711-9860-f9e8df9ce79e",
      "name": "IF NVI Valid?"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "tc_kimlik": "={{ $json.session.tc_kimlik }}",
            "patient_name": "={{ $json.session.patient_name }}",
            "birth_year": "={{ $json.session.birth_year || \"\" }}",
            "nvi_attempts": "={{ $json.session.nvi_attempts || 0 }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        0,
        0
      ],
      "id": "39f43836-a230-44bf-98c0-71cb0945fa17",
      "name": "Sheets Update After NVI",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Parse NVI Response').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        0
      ],
      "id": "f1049405-db40-41e1-9500-b783f5209d3c",
      "name": "WA Send NVI Result"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "={{ $json.session.state }}",
            "nvi_attempts": "={{ $json.session.nvi_attempts || 0 }}",
            "updated_at": "={{ $json.session.updated_at }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        0,
        128
      ],
      "id": "98340c8f-b22d-44e6-948f-9a68ec1f0e63",
      "name": "Sheets Update NVI Fail",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($('Parse NVI Response').first().json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        128
      ],
      "id": "65a4c0a5-76f8-458e-ac08-d0dc492e7bdf",
      "name": "WA Send NVI Error"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '🔄 Randevu değiştirme özelliği yakında aktif olacaktır.\\nLütfen kliniğimizi arayın:\\n📞 (0332) XXX XX XX' }\n};\nreturn { json: { payload } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        864
      ],
      "id": "5689d582-520a-49dd-b2bb-cc83dbcf6379",
      "name": "Handle Change Button"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1200,
        864
      ],
      "id": "0a2cae46-5d62-4057-bb66-543362edaf66",
      "name": "WA Send Change Placeholder"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const from = $('Parse WhatsApp').first().json.from;\nconst payload = {\n  messaging_product: 'whatsapp',\n  to: from,\n  type: 'text',\n  text: { body: '❌ Randevu iptal özelliği yakında aktif olacaktır.\\nLütfen kliniğimizi arayın:\\n📞 (0332) XXX XX XX' }\n};\nreturn { json: { payload } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        1008
      ],
      "id": "11401c6f-0fb6-4d04-928b-161d6fdabb24",
      "name": "Handle Cancel Button"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v19.0/946139791926894/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAFrzxRaKZCzABQvusDajvgD3yGLqVZCIVVoVHaMhkhYbRx7G7A6PLUrYQuOka2i5VrJyaeIihSZBRxTAeZBD85fozueXyui3YJMkHpjxg4uZB7JredLcigNQPnFX9ZAUGk8hvx3pFIoItHZAqEn7UglV3oi6PFSzUMiZAvm2WZCAcqlKgfOZAIbN3Wn4k2lZCOYtxj75drKSqaAPbOSF5qPZAsr2OuzR7CDgwpPTcZCucHdDiFvMKvnLShZBSJhZCnUMg47wo7BnxEkesDMjWBF6AeeVkOj"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1200,
        1008
      ],
      "id": "cb20bfaf-a02f-4730-9bf8-bdc916804624",
      "name": "WA Send Cancel Placeholder"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4",
          "mode": "list",
          "cachedResultName": "Whatsapp Appointment",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "booking_sessions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1aS3NQXuIk2f7Su2CqZNJp8_tv8qsEWoYEdJJaNK_bz4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $json.session.session_id }}",
            "state": "AWAITING_NOTES",
            "updated_at": "={{ $now.toISO() }}",
            "row_number": 0
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "channel",
              "displayName": "channel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_id",
              "displayName": "service_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "doctor_id",
              "displayName": "doctor_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_start",
              "displayName": "selected_slot_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "selected_slot_end",
              "displayName": "selected_slot_end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_event_id",
              "displayName": "hold_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hold_expires_at",
              "displayName": "hold_expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_name",
              "displayName": "patient_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tc_kimlik",
              "displayName": "tc_kimlik",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "birth_year",
              "displayName": "birth_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nvi_attempts",
              "displayName": "nvi_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "flow_type",
              "displayName": "flow_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "patient_notes",
              "displayName": "patient_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "complaint_text",
              "displayName": "complaint_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "complaint_tag",
              "displayName": "complaint_tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_id",
              "displayName": "last_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1440,
        580
      ],
      "id": "69841ed4-e3bb-449f-8c8f-b833e6eb7b2b",
      "name": "Sheets Update Skip To Notes",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gi9bfnlGLt1sQkYj",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "WA Webhook": {
      "main": [
        [],
        [
          {
            "node": "IF GET Verify?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF GET Verify?": {
      "main": [
        [
          {
            "node": "Respond Challenge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse WhatsApp": {
      "main": [
        [
          {
            "node": "IF Drop?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Drop?": {
      "main": [
        [],
        [
          {
            "node": "Sheets Get Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Get Session": {
      "main": [
        [
          {
            "node": "Upsert+Idempotency",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert+Idempotency": {
      "main": [
        [
          {
            "node": "IF Stop?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Stop?": {
      "main": [
        [],
        [
          {
            "node": "Sheets Upsert Session Early",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Upsert Session Early": {
      "main": [
        [
          {
            "node": "Sheets Read Services",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Read Services": {
      "main": [
        [
          {
            "node": "Sheets Read Doctors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Read Doctors": {
      "main": [
        [
          {
            "node": "Derive Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF AI Triage?": {
      "main": [
        [
          {
            "node": "Build Services Lines",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router A",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Services Lines": {
      "main": [
        [
          {
            "node": "AI Triage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Triage",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Triage": {
      "main": [
        [
          {
            "node": "Merge AI->Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge AI->Session": {
      "main": [
        [
          {
            "node": "Sheets Update Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router A": {
      "main": [
        [
          {
            "node": "Sheets Update Session Service",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Services Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Update Session Doctor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Filter Doctors",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router B1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Services Payload": {
      "main": [
        [
          {
            "node": "WA Send Services",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Doctors": {
      "main": [
        [
          {
            "node": "Build Doctors Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doctors Payload": {
      "main": [
        [
          {
            "node": "WA Send Doctors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor+Duration": {
      "main": [
        [
          {
            "node": "Fetch Calendar Freebusy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Slots Payload": {
      "main": [
        [
          {
            "node": "WA Send Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Derive Slot Event": {
      "main": [
        [
          {
            "node": "Sheets Update After Slot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update After Slot": {
      "main": [
        [
          {
            "node": "Create HOLD Event",
            "type": "main",
            "index": 0
          },
          {
            "node": "Resolve Doctor For Hold",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create HOLD Event": {
      "main": [
        [
          {
            "node": "Set HELD + TTL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set HELD + TTL": {
      "main": [
        [
          {
            "node": "Sheets Update HELD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update HELD": {
      "main": [
        [
          {
            "node": "Build Confirm Buttons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Confirm Buttons": {
      "main": [
        [
          {
            "node": "WA Send Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Confirm/Change/Cancel": {
      "main": [
        [
          {
            "node": "IF Confirm Guard",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Hold Exists (Change)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Hold Exists (Cancel)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Confirm Guard": {
      "main": [
        [
          {
            "node": "Router Name Collection",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Expired On Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirm Event Update": {
      "main": [
        [
          {
            "node": "Append Appointment Ledger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Appointment Ledger": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sheets Set CONFIRMED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Final Text": {
      "main": [
        [
          {
            "node": "WA Send Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router B1": {
      "main": [
        [
          {
            "node": "Derive Slot Event",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF Hold Expired",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor For Hold": {
      "main": [
        [
          {
            "node": "IF Stop Hold",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Stop Hold": {
      "main": [
        [],
        [
          {
            "node": "Create HOLD Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor For Confirm": {
      "main": [
        [
          {
            "node": "Confirm Event Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Calendar Freebusy": {
      "main": [
        [
          {
            "node": "Generate Real Slots from Freebusy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Real Slots from Freebusy": {
      "main": [
        [
          {
            "node": "IF No Slots?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Hold Exists (Change)": {
      "main": [
        [
          {
            "node": "Delete Hold Event (Change)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reset Session for Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Hold Event (Change)": {
      "main": [
        [
          {
            "node": "Reset Session for Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Session for Change": {
      "main": [
        [
          {
            "node": "Update Session After Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session After Change": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Hold Exists (Cancel)": {
      "main": [
        [
          {
            "node": "Delete Hold Event (Cancel)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reset Session for Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Hold Event (Cancel)": {
      "main": [
        [
          {
            "node": "Reset Session for Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Session for Cancel": {
      "main": [
        [
          {
            "node": "Update Session After Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session After Cancel": {
      "main": [
        [
          {
            "node": "IF Ledger Entry Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Cancel Message": {
      "main": [
        [
          {
            "node": "WA Send Cancel Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Hold Expired": {
      "main": [
        [
          {
            "node": "Resolve Doctor For Expiry",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Derive Slot Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Doctor For Expiry": {
      "main": [
        [
          {
            "node": "Delete Expired Hold",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Expired Hold": {
      "main": [
        [
          {
            "node": "Reset Session After Expiry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset Session After Expiry": {
      "main": [
        [
          {
            "node": "Update Session After Expiry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session After Expiry": {
      "main": [
        [
          {
            "node": "Build Expiry Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Expiry Message": {
      "main": [
        [
          {
            "node": "WA Send Expiry Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Send Expiry Message": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Name Collection": {
      "main": [
        [
          {
            "node": "Sheets Update Skip To Notes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Name Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Name Request": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_NAME",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Session With Name": {
      "main": [
        [
          {
            "node": "Build Notes Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Derive Event": {
      "main": [
        [
          {
            "node": "Router State Handler Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_NAME": {
      "main": [
        [
          {
            "node": "WA Send Name Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF No Slots?": {
      "main": [
        [
          {
            "node": "Build No Slots Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Slots Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build No Slots Msg": {
      "main": [
        [
          {
            "node": "WA Send No Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router State Handler Updated": {
      "main": [
        [
          {
            "node": "Handle Book Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Change Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Cancel Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Welcome",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process TC Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Fullname Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Birth Year Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Store Patient Name Updated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Store Patient Notes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Welcome",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router Confirm/Change/Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router Confirm/Change/Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router Confirm/Change/Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Derive Slot Event",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF AI Triage?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Update Session Doctor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Filter Doctors",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Already Confirmed Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Welcome": {
      "main": [
        [
          {
            "node": "WA Send Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Send Welcome": {
      "main": [
        [
          {
            "node": "Update State After Welcome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Patient Name Updated": {
      "main": [
        [
          {
            "node": "IF Invalid Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Notes Request": {
      "main": [
        [
          {
            "node": "WA Send Notes Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Patient Notes": {
      "main": [
        [
          {
            "node": "Sheets Update Notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Notes": {
      "main": [
        [
          {
            "node": "Resolve Doctor For Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doctor WA Notify": {
      "main": [
        [
          {
            "node": "WA Send Doctor Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doctor SMS": {
      "main": [
        [
          {
            "node": "Send SMS Netgsm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Appointment Cancelled": {
      "main": [
        [
          {
            "node": "Build Cancel Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a message": {
      "main": [
        [
          {
            "node": "Build Doctor WA Notify",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Doctor SMS",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Final Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Session Doctor": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Expired On Confirm": {
      "main": [
        [
          {
            "node": "WA Send Expired Confirm Msg",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sheets Update Expired Confirm",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete Expired Hold On Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Expired Confirm": {
      "main": [
        [
          {
            "node": "Resolve Doctor+Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Ledger Entry Exists": {
      "main": [
        [
          {
            "node": "Update Appointment Cancelled",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Cancel Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Session": {
      "main": [
        [
          {
            "node": "Restore Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Invalid Name": {
      "main": [
        [
          {
            "node": "Build Retry Name Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Session With Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Retry Name Msg": {
      "main": [
        [
          {
            "node": "WA Send Retry Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Session Service": {
      "main": [
        [
          {
            "node": "Filter Doctors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Already Confirmed Msg": {
      "main": [
        [
          {
            "node": "WA Send Already Confirmed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Context": {
      "main": [
        [
          {
            "node": "Router A",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update State After Welcome": {
      "main": [
        [
          {
            "node": "Restore Welcome Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Welcome Context": {
      "main": [
        [
          {
            "node": "IF AI Triage?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Book Button": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_TC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_TC": {
      "main": [
        [
          {
            "node": "WA Send TC Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process TC Input": {
      "main": [
        [
          {
            "node": "IF TC Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF TC Valid?": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_FULLNAME",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Send TC Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_FULLNAME": {
      "main": [
        [
          {
            "node": "WA Send TC Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Fullname Input": {
      "main": [
        [
          {
            "node": "IF Name Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Name Valid?": {
      "main": [
        [
          {
            "node": "Sheets Update AWAITING_BIRTH_YEAR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Send Name Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update AWAITING_BIRTH_YEAR": {
      "main": [
        [
          {
            "node": "WA Send Name Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Birth Year Input": {
      "main": [
        [
          {
            "node": "IF Year Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Year Valid?": {
      "main": [
        [
          {
            "node": "NVI SOAP Call",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Send Year Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NVI SOAP Call": {
      "main": [
        [
          {
            "node": "Parse NVI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse NVI Response": {
      "main": [
        [
          {
            "node": "IF NVI Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF NVI Valid?": {
      "main": [
        [
          {
            "node": "Sheets Update After NVI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sheets Update NVI Fail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update After NVI": {
      "main": [
        [
          {
            "node": "WA Send NVI Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update NVI Fail": {
      "main": [
        [
          {
            "node": "WA Send NVI Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Change Button": {
      "main": [
        [
          {
            "node": "WA Send Change Placeholder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Cancel Button": {
      "main": [
        [
          {
            "node": "WA Send Cancel Placeholder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sheets Update Skip To Notes": {
      "main": [
        [
          {
            "node": "Build Notes Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "60a46d33-a0f7-4b0f-8010-dcc10fa067ce",
  "meta": {
    "instanceId": "bed97b5b7d807e8a88d9f97466b8d7787025c0cfbaaba67e1749d8eef9d2ed3a"
  },
  "id": "59j8wrf-gCiWjMwtFAnUT",
  "tags": []
}